<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>MediNöbet - Pro</title>
<!-- iOS PWA Ayarları -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MediNöbet">
<link rel="apple-touch-icon" href="icon.png">
<!-- Kütüphaneler -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<!-- Excel Kütüphanesi -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<link rel="manifest" href="manifest.json">
<style>

        body { 

            font-family: 'Varela Round', sans-serif; 

            background-color: #f8fafc; 

            -webkit-tap-highlight-color: transparent;

            padding-top: env(safe-area-inset-top);

            padding-bottom: env(safe-area-inset-bottom);

        }

        .glass-card { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(226, 232, 240, 0.8); }

        .tab-active { color: #dc2626; border-bottom: 3px solid #dc2626; }

        .tab-inactive { color: #94a3b8; }

        .cal-day { 

            min-height: 90px; display: flex; flex-direction: column; align-items: start; justify-content: start; 

            padding: 4px; cursor: pointer; border-radius: 8px; transition: all 0.2s; position: relative; 

            border: 1px solid #e2e8f0; background: white; overflow: hidden;

        }

        .cal-day:active { transform: scale(0.98); border-color: #dc2626; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .status-ok { background-color: #f0fdf4; border-color: #86efac; }

        .status-error { background-color: #fef2f2; border-color: #fca5a5; }

        .status-neutral { background-color: #ffffff; border-color: #e2e8f0; }

        .pref-wanted { background-color: #22c55e !important; color: white !important; }

        .pref-blocked { background-color: #ef4444 !important; color: white !important; }

        .modal { transition: opacity 0.2s ease; }

        body.modal-active { overflow: hidden; }

        .premium-gradient { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #7a5c00; }
</style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">
<!-- Üst Bar -->
<header class="bg-gradient-to-r from-red-600 to-red-800 text-white p-4 shadow-lg z-20">
<div class="flex justify-between items-center max-w-3xl mx-auto">
<div class="flex items-center gap-3">
<img src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Flag_of_Turkey.svg" alt="Türk Bayrağı" class="h-8 w-auto drop-shadow-md rounded-sm border border-white/20">
<div>
<h1 class="text-xl font-bold leading-tight tracking-tight">MediNöbet</h1>
<p class="text-[10px] text-red-100 opacity-90 font-light tracking-wide">Generated by ATAOL AI Techs</p>
</div>
</div>
<button onclick="downloadFullReport()" class="bg-black/20 hover:bg-black/30 backdrop-blur-sm px-3 py-1.5 rounded-lg text-xs font-bold shadow transition flex items-center border border-white/20">
<i class="fa-solid fa-share-from-square mr-1.5"></i> Raporu Paylaş
</button>
</div>
</header>
<!-- Tab Menü -->
<nav class="bg-white shadow-sm z-10 border-b border-slate-100">
<div class="flex max-w-3xl mx-auto">
<button onclick="switchTab('calendar')" id="tab-calendar" class="flex-1 py-3 text-center font-bold text-sm tab-active transition">
<i class="fa-regular fa-calendar-days mb-1 block"></i> Takvim
</button>
<button onclick="switchTab('doctors')" id="tab-doctors" class="flex-1 py-3 text-center font-bold text-sm tab-inactive transition">
<i class="fa-solid fa-user-nurse mb-1 block"></i> Personel
</button>
<button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-3 text-center font-bold text-sm tab-inactive transition">
<i class="fa-solid fa-sliders mb-1 block"></i> Ayarlar
</button>
</div>
</nav>
<!-- Ana İçerik Alanı -->
<main class="flex-1 overflow-y-auto p-4 max-w-3xl mx-auto w-full relative pb-24">
<!-- 1. TAKVİM GÖRÜNÜMÜ -->
<div id="view-calendar" class="space-y-4">
<div class="flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
<button onclick="changeMonth(-1)" class="p-2 text-red-600 hover:bg-red-50 rounded-full transition"><i class="fa-solid fa-chevron-left"></i></button>
<h2 id="currentMonthLabel" class="text-lg font-bold text-slate-800">Ekim 2023</h2>
<button onclick="changeMonth(1)" class="p-2 text-red-600 hover:bg-red-50 rounded-full transition"><i class="fa-solid fa-chevron-right"></i></button>
</div>
<div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
<div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-500 mb-2 border-b border-slate-100 pb-2">
<div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div class="text-red-500">Paz</div>
</div>
<div id="calendarGrid" class="grid grid-cols-7 gap-1.5"></div>
</div>
<div class="text-xs text-center text-slate-400 mt-2 flex justify-center gap-4">
<div class="flex items-center"><span class="w-2.5 h-2.5 bg-red-100 border border-red-300 rounded-full mr-1.5"></span> Eksik/Hata</div>
<div class="flex items-center"><span class="w-2.5 h-2.5 bg-green-100 border border-green-300 rounded-full mr-1.5"></span> Tamam</div>
</div>
</div>
<!-- 2. PERSONEL YÖNETİMİ -->
<div id="view-doctors" class="hidden space-y-4">
<div class="glass-card p-5 rounded-2xl shadow-sm border-l-4 border-red-500">
<h3 class="font-bold text-red-600 mb-3 flex items-center">
<i class="fa-solid fa-user-plus mr-2"></i> Yeni Personel Ekle
</h3>
<input type="text" id="docNameInput" placeholder="Ad Soyad (Örn: Uzm.Dr. Feride GÜL)" class="w-full p-3 rounded-xl border border-slate-200 mb-4 focus:outline-none focus:ring-2 focus:ring-red-500 transition bg-slate-50">
<p class="text-xs text-slate-500 mb-2 font-medium">Nöbet Tercihleri:</p>
<div class="flex gap-2 text-[10px] mb-2">
<span class="bg-green-100 text-green-700 px-2 py-1 rounded">1 Tık: İstiyor</span>
<span class="bg-red-100 text-red-700 px-2 py-1 rounded">2 Tık: İstemiyor</span>
</div>
<div class="bg-white p-3 rounded-xl border border-slate-200 mb-4">
<div class="flex justify-between mb-2 px-1">
<button onclick="changePrefMonth(-1)" class="text-xs px-2"><i class="fa-solid fa-chevron-left"></i></button>
<span id="prefMonthLabel" class="text-xs font-bold text-slate-600">Ay</span>
<button onclick="changePrefMonth(1)" class="text-xs px-2"><i class="fa-solid fa-chevron-right"></i></button>
</div>
<div id="prefGrid" class="grid grid-cols-7 gap-1"></div>
</div>
<button onclick="saveDoctor()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition active:scale-95">

                    Kaydet
</button>
</div>
<div class="flex justify-between items-end">
<h3 class="font-bold text-slate-700 ml-1">Kayıtlı Personel</h3>
<span id="docCountBadge" class="text-[10px] bg-slate-200 px-2 py-1 rounded-full text-slate-600">Sınırsız</span>
</div>
<ul id="doctorsList" class="space-y-2"></ul>
</div>
<!-- 3. AYARLAR -->
<div id="view-settings" class="hidden space-y-4">
<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
<h3 class="font-bold text-slate-700 mb-2 flex items-center">
<i class="fa-solid fa-list-check mr-2 text-red-500"></i> Nöbet Sahaları
</h3>
<p class="text-xs text-slate-500 mb-4">Nöbet yerlerini ve kişi sayılarını buradan yönetebilirsiniz.</p>
<div id="slotsConfigList" class="space-y-3"></div>
<button onclick="addNewSlot()" class="w-full mt-4 py-3 border-2 border-dashed border-slate-300 text-slate-500 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-700 transition">
<i class="fa-solid fa-plus mr-1"></i> Yeni Saha Ekle
</button>
<div class="h-px bg-slate-100 my-6"></div>
<h4 class="font-bold text-slate-700 text-sm mb-3 border-l-4 border-blue-500 pl-2">Rapor İşlemleri</h4>
<div class="grid grid-cols-1 gap-3 mb-6">
<button onclick="downloadReport()" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl shadow hover:bg-green-700 transition flex items-center justify-center gap-2 text-sm">
<i class="fa-solid fa-share-nodes text-lg"></i> 
<div class="text-left leading-tight">
<div>Özet Raporu Paylaş</div>
<div class="text-[10px] opacity-80 font-normal">Kişi Bazlı (CSV)</div>
</div>
</button>
<button onclick="downloadScheduleReport()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow hover:bg-blue-700 transition flex items-center justify-center gap-2 text-sm">
<i class="fa-solid fa-share-nodes text-lg"></i>
<div class="text-left leading-tight">
<div>Çizelgeyi Paylaş</div>
<div class="text-[10px] opacity-80 font-normal">Tarih Bazlı (CSV)</div>
</div>
</button>
<button onclick="downloadFullReport()" class="w-full bg-slate-700 text-white font-bold py-3.5 rounded-xl shadow hover:bg-slate-800 transition flex items-center justify-center gap-2 text-sm mt-1">
<i class="fa-solid fa-file-excel text-lg text-green-400"></i>
<div class="text-left leading-tight">
<div>Tam Excel Olarak Paylaş</div>
<div class="text-[10px] opacity-80 font-normal">Tek dosyada tüm raporlar (.xlsx)</div>
</div>
</button>
</div>
<div class="h-px bg-slate-100 my-6"></div>
<button onclick="saveSettings()" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-slate-900 transition">

                    Ayarları Güncelle
</button>
<div class="mt-6 text-center">
<button onclick="clearAllSystem()" class="text-xs text-red-500 hover:text-red-700 font-medium underline">

                        Tüm Verileri Sıfırla
</button>
</div>
</div>
</div>
</main>
<!-- Footer -->
<footer class="bg-white border-t border-slate-200 p-6 text-center z-10 safe-area-pb">
<div class="max-w-md mx-auto">
<div class="inline-block shadow-md mb-2">
<img src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Flag_of_Turkey.svg" alt="Türkiye" class="h-6 w-auto rounded-[2px] border border-slate-100">
</div>
<p class="text-slate-600 italic font-serif text-sm">"Beni Türk hekimlerine emanet ediniz."</p>
<p class="text-slate-900 font-bold text-xs mt-1 tracking-widest uppercase">ATATÜRK</p>
</div>
</footer>
<!-- NÖBET ATAMA MODALI -->
<div id="dayModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-end sm:items-center justify-center z-50">
<div class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('dayModal')"></div>
<div class="modal-container bg-white w-full max-w-md mx-auto rounded-t-3xl sm:rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] flex flex-col">
<div class="bg-red-600 p-4 text-white rounded-t-3xl sm:rounded-t-2xl sticky top-0 z-10 flex justify-between items-center shadow-md">
<div>
<h3 id="modalDateTitle" class="text-lg font-bold">Tarih</h3>
<p class="text-xs text-red-100">Personel Atama Ekranı</p>
</div>
<button onclick="closeModal('dayModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
</div>
<div class="p-4 space-y-4 flex-1 bg-slate-50">
<div id="restWarningBox" class="hidden bg-slate-200 text-slate-600 text-xs p-3 rounded-lg mb-2 border border-slate-300">
<i class="fa-solid fa-bed mr-1.5 text-slate-500"></i> <strong id="restingCount" class="text-slate-800">0</strong> personel dün nöbetçi olduğu için listede gösterilmiyor.
</div>
<div id="modalWarnings" class="hidden bg-amber-50 border border-amber-200 text-amber-800 text-xs p-3 rounded-xl shadow-sm"></div>
<div id="modalSlotsArea" class="space-y-4"></div>
</div>
<div class="p-4 border-t bg-white sticky bottom-0 safe-area-pb">
<button onclick="closeModal('dayModal')" class="w-full bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 active:scale-95 transition">Tamam</button>
</div>
</div>
</div>
<!-- İSTATİSTİK MODALI -->
<div id="statsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-end sm:items-center justify-center z-50">
<div class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('statsModal')"></div>
<div class="modal-container bg-white w-full max-w-md mx-auto rounded-t-3xl sm:rounded-2xl shadow-2xl z-50 overflow-hidden flex flex-col">
<div class="bg-slate-800 p-4 text-white rounded-t-3xl sm:rounded-t-2xl flex justify-between items-center">
<h3 id="statsDocTitle" class="text-lg font-bold">İstatistikler</h3>
<button onclick="closeModal('statsModal')" class="text-white hover:bg-slate-700 p-2 rounded-full"><i class="fa-solid fa-xmark"></i></button>
</div>
<div id="statsContent" class="p-5 overflow-y-auto max-h-[80vh] bg-slate-50"></div>
</div>
</div>
<!-- PREMIUM MODAL -->
<div id="premiumModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 px-4">
<div class="modal-overlay absolute w-full h-full bg-slate-900/80 backdrop-blur-sm" onclick="closeModal('premiumModal')"></div>
<div class="modal-container bg-white w-full max-w-sm mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden relative transform transition-all scale-95">
<div class="h-32 premium-gradient flex items-center justify-center relative overflow-hidden">
<i class="fa-solid fa-crown text-6xl text-white/30 absolute"></i>
<h2 class="text-3xl font-bold text-white relative z-10 drop-shadow-md">MediNöbet PRO</h2>
</div>
<div class="p-6 text-center">
<p class="text-slate-600 mb-6 text-sm">Ücretsiz sürümde sınırlı erişiminiz bulunmaktadır. Sınırsız kullanım için Pro'ya geçin.</p>
<ul class="text-left space-y-3 mb-8 text-sm">
<li class="flex items-center gap-3"><i class="fa-solid fa-check text-green-500"></i> Sınırsız Personel</li>
<li class="flex items-center gap-3"><i class="fa-solid fa-check text-green-500"></i> Sınırsız Saha</li>
<li class="flex items-center gap-3"><i class="fa-solid fa-check text-green-500"></i> Excel Raporu</li>
</ul>
<button onclick="buyPro()" class="w-full premium-gradient text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-95 text-lg flex items-center justify-center gap-2">
<span>399.99 ₺</span> <span class="text-xs opacity-80 font-normal">(Tek Seferlik)</span>
</button>
<button onclick="closeModal('premiumModal')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">Hayır, teşekkürler</button>
</div>
</div>
</div>
<script>

        // --- AYARLAR ---

        let currentDate = new Date();

        let currentPrefDate = new Date();

        let settings = JSON.parse(localStorage.getItem('mediSettings')) || {

            slots: [

                { id: 1, name: "Servis", min: 1, max: 2 },

                { id: 2, name: "Acil", min: 1, max: 2 },

                { id: 3, name: "Triyaj", min: 1, max: 1 }

            ]

        };

        let doctors = JSON.parse(localStorage.getItem('mediDoctors')) || [];

        let assignments = JSON.parse(localStorage.getItem('mediAssignments')) || {};

        let editingDoc = { id: null, name: "", prefs: {} };

        // Pro Kilitleri KALDIRILDI (Test için)

        // let isPremium = localStorage.getItem('mediIsPremium') === 'true'; 

        // const FREE_DOC_LIMIT = 3; ... 

        document.addEventListener('DOMContentLoaded', () => {

            renderCalendar();

            renderSettings();

            renderDoctorsList();

            renderPrefCalendar();

        });

        // --- TAB YÖNETİMİ ---

        function switchTab(tabName) {

            document.getElementById('view-calendar').classList.add('hidden');

            document.getElementById('view-doctors').classList.add('hidden');

            document.getElementById('view-settings').classList.add('hidden');

            ['calendar', 'doctors', 'settings'].forEach(t => {

                const btn = document.getElementById(`tab-${t}`);

                if(t === tabName) {

                    btn.classList.remove('tab-inactive');

                    btn.classList.add('tab-active');

                    document.getElementById(`view-${t}`).classList.remove('hidden');

                } else {

                    btn.classList.remove('tab-active');

                    btn.classList.add('tab-inactive');

                }

            });

            if(tabName === 'calendar') renderCalendar();

            if(tabName === 'doctors') {

                editingDoc = { id: null, name: "", prefs: {} };

                document.getElementById('docNameInput').value = "";

                renderPrefCalendar();

            }

        }

        // --- TAKVİM ---

        function changeMonth(dir) { currentDate.setMonth(currentDate.getMonth() + dir); renderCalendar(); }

        function renderCalendar() {

            const grid = document.getElementById('calendarGrid');

            const lbl = document.getElementById('currentMonthLabel');

            grid.innerHTML = '';

            const year = currentDate.getFullYear();

            const month = currentDate.getMonth();

            lbl.textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let startOffset = firstDay === 0 ? 6 : firstDay - 1;

            for(let i=0; i<startOffset; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++) {

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                const dateObj = new Date(year, month, d);

                const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'short' }); 

                const status = validateDayStatus(dateStr);

                let statusClass = 'status-neutral';

                if(status === 'error') statusClass = 'status-error'; else if(status === 'ok') statusClass = 'status-ok';

                let assignedNames = [];

                if(assignments[dateStr]) { Object.values(assignments[dateStr]).forEach(docs => { if(Array.isArray(docs)) assignedNames.push(...docs); }); }

                let namesHtml = '';

                if(assignedNames.length > 0) {

                    namesHtml = `<div class="w-full mt-1 flex flex-col gap-1 overflow-y-auto no-scrollbar" style="max-height: 100%;">`;

                    [...new Set(assignedNames)].forEach(name => {

                        namesHtml += `<div class="flex items-center justify-between bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 group"><span class="text-[9px] font-medium text-slate-700 truncate">${name}</span><button onclick="deleteAssignment(event, '${dateStr}', '${name}')" class="text-red-400 hover:text-red-600 text-[10px] w-3 h-3 flex items-center justify-center"><i class="fa-solid fa-times"></i></button></div>`;

                    });

                    namesHtml += `</div>`;

                }

                const dayDiv = document.createElement('div');

                dayDiv.className = `cal-day ${statusClass}`;

                dayDiv.innerHTML = `<div class="flex justify-between w-full items-baseline border-b border-black/5 pb-1 mb-1 shrink-0"><span class="font-bold text-sm leading-none text-slate-700">${d}</span><span class="text-[9px] font-bold uppercase text-slate-400 leading-none">${dayName}</span></div>${namesHtml}`;

                if(status === 'error') dayDiv.innerHTML += `<span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>`;

                dayDiv.onclick = () => openDayModal(dateStr);

                grid.appendChild(dayDiv);

            }

        }

        function deleteAssignment(e, dateStr, docName) {

            e.stopPropagation(); 

            if(!confirm(`${docName} silinsin mi?`)) return;

            if (assignments[dateStr]) {

                let changed = false;

                Object.keys(assignments[dateStr]).forEach(slotKey => {

                    if (assignments[dateStr][slotKey].includes(docName)) {

                        assignments[dateStr][slotKey] = assignments[dateStr][slotKey].filter(n => n !== docName);

                        changed = true;

                    }

                });

                if (changed) { localStorage.setItem('mediAssignments', JSON.stringify(assignments)); renderCalendar(); }

            }

        }

        function validateDayStatus(dateStr) {

            if(!assignments[dateStr]) return 'neutral'; 

            let dayAssigns = assignments[dateStr];

            let isOk = true; let hasAny = false;

            settings.slots.forEach(slot => {

                const assignedCount = (dayAssigns[`slot${slot.id}`] || []).length;

                if(assignedCount > 0) hasAny = true;

                if(assignedCount < slot.min || assignedCount > slot.max) isOk = false;

            });

            if(!hasAny) return 'neutral';

            return isOk ? 'ok' : 'error';

        }

        // --- ATAMA MODALI ---

        let selectedDateStr = "";

        function openDayModal(dateStr) {

            selectedDateStr = dateStr;

            const dateObj = new Date(dateStr);

            document.getElementById('modalDateTitle').textContent = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });

            document.getElementById('dayModal').classList.remove('opacity-0', 'pointer-events-none');

            document.body.classList.add('modal-active');

            renderModalSlots();

        }

        function closeModal(modalId) {

            document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');

            document.body.classList.remove('modal-active');

            if(modalId === 'dayModal') renderCalendar();

        }

        function renderModalSlots() {

            const container = document.getElementById('modalSlotsArea');

            container.innerHTML = '';

            let dayAssigns = assignments[selectedDateStr] || {};

            let warnings = [];

            const d = new Date(selectedDateStr); d.setDate(d.getDate() - 1);

            const prevDateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

            let restingDoctors = [];

            if(assignments[prevDateStr]) { Object.values(assignments[prevDateStr]).forEach(list => { if(Array.isArray(list)) restingDoctors.push(...list); }); }

            restingDoctors = [...new Set(restingDoctors)];

            const restInfoBox = document.getElementById('restWarningBox');

            if(restingDoctors.length > 0) { restInfoBox.classList.remove('hidden'); document.getElementById('restingCount').textContent = restingDoctors.length; } else { restInfoBox.classList.add('hidden'); }

            let sortedDoctors = [...doctors].sort((a, b) => {

                const prefA = a.prefs[selectedDateStr] || 0;

                const prefB = b.prefs[selectedDateStr] || 0;

                const getWeight = (p) => p === 1 ? 0 : (p === 0 ? 1 : 2);

                return getWeight(prefA) - getWeight(prefB);

            });

            settings.slots.forEach(slot => {

                const currentDocs = dayAssigns[`slot${slot.id}`] || [];

                const slotDiv = document.createElement('div');

                slotDiv.className = "border border-slate-200 rounded-xl p-3 bg-white shadow-sm";

                let countColor = "text-slate-500";

                if(currentDocs.length < slot.min) { countColor = "text-red-600 font-bold"; warnings.push(`${slot.name}: Eksik personel.`); }

                else if(currentDocs.length > slot.max) { countColor = "text-red-600 font-bold"; warnings.push(`${slot.name}: Fazla personel.`); }

                else if(currentDocs.length > 0) { countColor = "text-green-600 font-bold"; }

                slotDiv.innerHTML = `<div class="flex justify-between items-center mb-2.5"><span class="font-bold text-sm text-slate-800">${slot.name}</span><span class="text-xs ${countColor} bg-slate-100 px-2 py-0.5 rounded-full">(${currentDocs.length} / ${slot.min}-${slot.max})</span></div>`;

                const buttonsDiv = document.createElement('div');

                buttonsDiv.className = "flex flex-wrap gap-2";

                sortedDoctors.forEach(doc => {

                    const isAssignedHere = currentDocs.includes(doc.name);

                    const isResting = restingDoctors.includes(doc.name);

                    if (isResting && !isAssignedHere) return;

                    const pref = doc.prefs[selectedDateStr] || 0; 

                    let btnClass = "px-3 py-2 rounded-lg text-xs border transition flex items-center gap-1.5 font-medium ";

                    let icon = ""; let additionalText = "";

                    if(isAssignedHere) {

                        btnClass += "bg-red-600 text-white border-red-600 shadow-md transform scale-105"; icon = `<i class="fa-solid fa-check"></i>`;

                        if(isResting) { btnClass = "px-3 py-2 rounded-lg text-xs border bg-amber-500 text-white border-amber-600"; additionalText = "(Yorgun!)"; }

                    } else { btnClass += "bg-white text-slate-600 border-slate-200 hover:bg-slate-50"; }

                    if(!isAssignedHere) { if(pref === 1) icon += `<i class="fa-solid fa-star text-yellow-400"></i>`; if(pref === 2) icon += `<i class="fa-solid fa-ban text-red-400"></i>`; }

                    const btn = document.createElement('button'); btn.className = btnClass; btn.innerHTML = `${icon} ${doc.name} ${additionalText}`; btn.onclick = () => toggleAssignment(slot.id, doc.name); buttonsDiv.appendChild(btn);

                });

                slotDiv.appendChild(buttonsDiv); container.appendChild(slotDiv);

            });

            const warnBox = document.getElementById('modalWarnings');

            if(warnings.length > 0) { warnBox.classList.remove('hidden'); warnBox.innerHTML = `<strong>Durum:</strong><ul class="list-disc list-inside mt-1">${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`; } else { warnBox.classList.add('hidden'); }

        }

        function toggleAssignment(slotId, docName) {

            if(!assignments[selectedDateStr]) assignments[selectedDateStr] = {};

            let slotKey = `slot${slotId}`;

            let current = assignments[selectedDateStr][slotKey] || [];

            if(current.includes(docName)) { current = current.filter(n => n !== docName); } else {

                settings.slots.forEach(s => { let k = `slot${s.id}`; if(assignments[selectedDateStr][k] && assignments[selectedDateStr][k].includes(docName)) { assignments[selectedDateStr][k] = assignments[selectedDateStr][k].filter(n => n !== docName); } });

                current.push(docName);

            }

            assignments[selectedDateStr][slotKey] = current;

            localStorage.setItem('mediAssignments', JSON.stringify(assignments));

            renderModalSlots();

        }

        // --- YARDIMCI ---

        function changePrefMonth(dir) { currentPrefDate.setMonth(currentPrefDate.getMonth() + dir); renderPrefCalendar(); }

        function renderPrefCalendar() { const grid = document.getElementById('prefGrid'); const lbl = document.getElementById('prefMonthLabel'); grid.innerHTML = ''; const year = currentPrefDate.getFullYear(); const month = currentPrefDate.getMonth(); lbl.textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' }); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); let startOffset = firstDay === 0 ? 6 : firstDay - 1; for(let i=0; i<startOffset; i++) grid.innerHTML += `<div></div>`; for(let d=1; d<=daysInMonth; d++) { const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const pref = editingDoc.prefs[dateStr] || 0; const dayDiv = document.createElement('div'); let colorClass = "bg-white text-slate-600 border border-slate-100"; if(pref === 1) colorClass = "pref-wanted"; if(pref === 2) colorClass = "pref-blocked"; dayDiv.className = `h-8 flex items-center justify-center rounded cursor-pointer text-xs font-bold ${colorClass}`; dayDiv.textContent = d; dayDiv.onclick = () => { let next = (pref + 1) % 3; if(next === 0) delete editingDoc.prefs[dateStr]; else editingDoc.prefs[dateStr] = next; renderPrefCalendar(); }; grid.appendChild(dayDiv); } }

        function saveDoctor() { const name = document.getElementById('docNameInput').value.trim(); if(!name) { alert('İsim giriniz.'); return; } const formattedName = name; if(editingDoc.id) { const idx = doctors.findIndex(d => d.id === editingDoc.id); doctors[idx] = { ...editingDoc, name: formattedName }; } else { doctors.push({ id: Date.now(), name: formattedName, prefs: editingDoc.prefs }); } localStorage.setItem('mediDoctors', JSON.stringify(doctors)); document.getElementById('docNameInput').value = ""; editingDoc = { id: null, name: "", prefs: {} }; renderPrefCalendar(); renderDoctorsList(); alert('Kaydedildi!'); }

        function editDoctor(id) { const doc = doctors.find(d => d.id === id); if(doc) { editingDoc = JSON.parse(JSON.stringify(doc)); document.getElementById('docNameInput').value = doc.name; renderPrefCalendar(); document.querySelector('main').scrollTop = 0; } }

        function deleteDoctor(id) { if(confirm('Silinecek?')) { doctors = doctors.filter(d => d.id !== id); localStorage.setItem('mediDoctors', JSON.stringify(doctors)); renderDoctorsList(); } }

        function showDoctorStats(docName) { /* ... İstatistik Kodu ... */ document.getElementById('statsDocTitle').textContent = `${docName}`; let stats = { total: 0, weekdays: 0, friday: 0, saturday: 0, sunday: 0, slots: {} }; settings.slots.forEach(s => stats.slots[s.name] = 0); Object.keys(assignments).forEach(dateStr => { let workedToday = false; settings.slots.forEach(s => { if(assignments[dateStr][`slot${s.id}`]?.includes(docName)) { stats.slots[s.name]++; workedToday = true; } }); if(workedToday) { stats.total++; const d = new Date(dateStr); const day = d.getDay(); if(day === 5) stats.friday++; else if(day === 6) stats.saturday++; else if(day === 0) stats.sunday++; else stats.weekdays++; } }); let html = `<div class="text-center mb-4"><div class="text-3xl font-bold text-red-600">${stats.total}</div><div class="text-xs">Toplam</div></div>`; document.getElementById('statsContent').innerHTML = html; document.getElementById('statsModal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); }

        function renderDoctorsList() { const list = document.getElementById('doctorsList'); list.innerHTML = ''; doctors.forEach(doc => { const li = document.createElement('li'); li.className = "flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-slate-100"; li.innerHTML = `<div class="flex items-center gap-3 cursor-pointer flex-1" onclick="showDoctorStats('${doc.name}')"><span class="font-bold text-sm">${doc.name}</span></div><div class="flex gap-2"><button onclick="editDoctor(${doc.id})" class="text-blue-500"><i class="fa-solid fa-pen"></i></button><button onclick="deleteDoctor(${doc.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`; list.appendChild(li); }); }

        function renderSettings() { const list = document.getElementById('slotsConfigList'); list.innerHTML = ''; settings.slots.forEach((slot, index) => { const div = document.createElement('div'); div.className = "flex gap-2 items-center text-sm p-2 bg-slate-50 rounded border"; div.innerHTML = `<input type="text" value="${slot.name}" onchange="updateSlot(${index}, 'name', this.value)" class="flex-1 bg-white border rounded p-1"><input type="number" value="${slot.min}" onchange="updateSlot(${index}, 'min', this.value)" class="w-10 text-center"><input type="number" value="${slot.max}" onchange="updateSlot(${index}, 'max', this.value)" class="w-10 text-center"><button onclick="deleteSlot(${index})" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`; list.appendChild(div); }); }

        function updateSlot(i, f, v) { if(f !== 'name') v = parseInt(v); settings.slots[i][f] = v; }

        function addNewSlot() { const newId = settings.slots.length > 0 ? Math.max(...settings.slots.map(s => s.id)) + 1 : 1; settings.slots.push({ id: newId, name: "Yeni Saha", min: 1, max: 2 }); renderSettings(); }

        function deleteSlot(i) { if(confirm("Silinecek?")) { settings.slots.splice(i, 1); renderSettings(); } }

        function saveSettings() { localStorage.setItem('mediSettings', JSON.stringify(settings)); alert('Ayarlar kaydedildi.'); renderCalendar(); }

        function clearAllSystem() { if(confirm('Sıfırlanacak?')) { localStorage.removeItem('mediAssignments'); localStorage.removeItem('mediDoctors'); location.reload(); } }

        // --- PAYLAŞILABİLİR RAPORLAMA ---

        // 1. ÖZET (CSV)

        async function downloadReport() {

            let csvContent = "\uFEFFİSİM;";

            settings.slots.forEach(s => csvContent += s.name.toUpperCase() + ";");

            csvContent += "TOPLAM;HAFTAİÇİ;CUMA;CUMARTESİ;PAZAR\n";

            const sortedDocs = [...doctors].sort((a, b) => a.name.localeCompare(b.name, 'tr'));

            sortedDocs.forEach(doc => {

                let stats = { total: 0, weekday: 0, friday: 0, saturday: 0, sunday: 0 };

                let slotCounts = {}; 

                settings.slots.forEach(s => slotCounts[`slot${s.id}`] = 0);

                Object.keys(assignments).forEach(dateStr => {

                    const d = new Date(dateStr);

                    const day = d.getDay(); 

                    let worked = false;

                    settings.slots.forEach(s => {

                        if(assignments[dateStr][`slot${s.id}`]?.includes(doc.name)) {

                            slotCounts[`slot${s.id}`]++;

                            worked = true;

                        }

                    });

                    if(worked) {

                        stats.total++;

                        if(day === 5) stats.friday++; else if(day === 6) stats.saturday++; else if(day === 0) stats.sunday++; else stats.weekday++;

                    }

                });

                let row = `"${doc.name}";`;

                settings.slots.forEach(s => row += slotCounts[`slot${s.id}`] + ";");

                row += `${stats.total};${stats.weekday};${stats.friday};${stats.saturday};${stats.sunday}\n`;

                csvContent += row;

            });

            await shareFile(csvContent, "MediNobet_Ozet.csv", "text/csv");

        }

        // 2. ÇİZELGE (CSV)

        async function downloadScheduleReport() {

            let csvContent = "\uFEFFTARİH;GÜN;";

            settings.slots.forEach(s => csvContent += s.name.toUpperCase() + ";");

            csvContent += "\n";

            const year = currentDate.getFullYear();

            const month = currentDate.getMonth();

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let d=1; d<=daysInMonth; d++) {

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                const dateObj = new Date(year, month, d);

                const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'long' });

                const formattedDate = `${String(d).padStart(2,'0')}.${String(month+1).padStart(2,'0')}.${year}`;

                let row = `${formattedDate};${dayName};`;

                settings.slots.forEach(s => {

                    const assigned = assignments[dateStr]?.[`slot${s.id}`] || [];

                    row += `"${assigned.join(' + ')}";`;

                });

                csvContent += row + "\n";

            }

            await shareFile(csvContent, "MediNobet_Cizelge.csv", "text/csv");

        }

        // 3. TAM RAPOR (XLSX)

        async function downloadFullReport() {

            const wb = XLSX.utils.book_new();

            // Sayfa 1: Özet

            let summaryData = [];

            let summaryHeaders = ["İSİM"];

            settings.slots.forEach(s => summaryHeaders.push(s.name.toUpperCase()));

            summaryHeaders.push("TOPLAM", "HAFTAİÇİ", "CUMA", "CUMARTESİ", "PAZAR");

            summaryData.push(summaryHeaders);

            const sortedDocs = [...doctors].sort((a, b) => a.name.localeCompare(b.name, 'tr'));

            sortedDocs.forEach(doc => {

                let stats = { total: 0, weekday: 0, friday: 0, saturday: 0, sunday: 0 };

                let slotCounts = {}; 

                settings.slots.forEach(s => slotCounts[`slot${s.id}`] = 0);

                Object.keys(assignments).forEach(dateStr => {

                    const d = new Date(dateStr);

                    const day = d.getDay(); 

                    let worked = false;

                    settings.slots.forEach(s => {

                        if(assignments[dateStr][`slot${s.id}`]?.includes(doc.name)) {

                            slotCounts[`slot${s.id}`]++;

                            worked = true;

                        }

                    });

                    if(worked) {

                        stats.total++;

                        if(day === 5) stats.friday++; else if(day === 6) stats.saturday++; else if(day === 0) stats.sunday++; else stats.weekday++;

                    }

                });

                let row = [doc.name];

                settings.slots.forEach(s => row.push(slotCounts[`slot${s.id}`]));

                row.push(stats.total, stats.weekday, stats.friday, stats.saturday, stats.sunday);

                summaryData.push(row);

            });

            // Sayfa 2: Çizelge

            let scheduleData = [];

            let scheduleHeaders = ["TARİH", "GÜN"];

            settings.slots.forEach(s => scheduleHeaders.push(s.name.toUpperCase()));

            scheduleData.push(scheduleHeaders);

            const year = currentDate.getFullYear();

            const month = currentDate.getMonth();

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let d=1; d<=daysInMonth; d++) {

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                const dateObj = new Date(year, month, d);

                const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'long' });

                const formattedDate = `${String(d).padStart(2,'0')}.${String(month+1).padStart(2,'0')}.${year}`;

                let row = [formattedDate, dayName];

                settings.slots.forEach(s => {

                    const assigned = assignments[dateStr]?.[`slot${s.id}`] || [];

                    row.push(assigned.join(' + '));

                });

                scheduleData.push(row);

            }

            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);

            const ws2 = XLSX.utils.aoa_to_sheet(scheduleData);

            XLSX.utils.book_append_sheet(wb, ws1, "Özet Rapor");

            XLSX.utils.book_append_sheet(wb, ws2, "Nöbet Çizelgesi");

            // Binary veri oluştur

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

            await shareFile(wbout, "MediNobet_Tam_Rapor.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

        }

        // PAYLAŞIM VE KAYDETME FONKSİYONU

        async function shareFile(content, filename, mimeType) {

            let file;

            if (content instanceof Uint8Array) {

                file = new File([content], filename, { type: mimeType });

            } else {

                file = new File([content], filename, { type: mimeType });

            }

            // iOS ve Android için Native Paylaşım

            if (navigator.canShare && navigator.canShare({ files: [file] })) {

                try {

                    await navigator.share({

                        files: [file],

                        title: 'MediNöbet Raporu',

                        text: 'Nöbet raporu ektedir.'

                    });

                } catch (err) {

                    console.log("Paylaşım iptal edildi veya hata: ", err);

                }

            } else {

                // Eski usül indirme (Masaüstü için)

                const url = URL.createObjectURL(file);

                const link = document.createElement("a");

                link.href = url;

                link.download = filename;

                document.body.appendChild(link);

                link.click();

                document.body.removeChild(link);

            }

        }

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(console.error); }
</script>
</body>
</html>
 
