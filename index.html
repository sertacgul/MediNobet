<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Medi Nöbet - Pro</title>
<!-- iOS PWA Ayarları -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Medi Nöbet">
<link rel="apple-touch-icon" href="icon.png">
<!-- Kütüphaneler -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<style>

        body { 

            font-family: 'Varela Round', sans-serif; 

            background-color: #f8fafc; 

            -webkit-tap-highlight-color: transparent;

            padding-top: env(safe-area-inset-top);

            padding-bottom: env(safe-area-inset-bottom);

        }

        .glass-card { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(226, 232, 240, 0.8); }

        .tab-active { color: #dc2626; border-bottom: 3px solid #dc2626; }

        .tab-inactive { color: #94a3b8; }

        .cal-day { 

            min-height: 90px; display: flex; flex-direction: column; align-items: start; justify-content: start; 

            padding: 4px; cursor: pointer; border-radius: 8px; transition: all 0.2s; position: relative; 

            border: 1px solid #e2e8f0; background: white; overflow: hidden;

        }

        .cal-day:active { transform: scale(0.98); border-color: #dc2626; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .status-ok { background-color: #f0fdf4; border-color: #86efac; }

        .status-error { background-color: #fef2f2; border-color: #fca5a5; }

        .status-neutral { background-color: #ffffff; border-color: #e2e8f0; }

        .pref-wanted { background-color: #22c55e !important; color: white !important; }

        .pref-blocked { background-color: #ef4444 !important; color: white !important; }

        .modal { transition: opacity 0.2s ease; }

        body.modal-active { overflow: hidden; }

        /* Premium Özellikler */

        .locked-feature { opacity: 0.5; pointer-events: none; filter: grayscale(1); position: relative; }

        .lock-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #475569; font-size: 24px; z-index: 10; }

        .premium-gradient { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #7a5c00; }
</style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">
<!-- Üst Bar -->
<header class="bg-gradient-to-r from-red-600 to-red-800 text-white p-4 shadow-lg z-20">
<div class="flex justify-between items-center max-w-3xl mx-auto">
<div class="flex items-center gap-3">
<!-- Orijinal Türk Bayrağı SVG -->
<img src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Flag_of_Turkey.svg" alt="Türk Bayrağı" class="h-8 w-auto drop-shadow-md rounded-sm">
<div>
<h1 class="text-xl font-bold leading-tight tracking-tight">MediNöbet</h1>
<p class="text-[10px] text-red-100 opacity-90 font-light tracking-wide">Generated by ATAOL AI Techs</p>
</div>
</div>
<!-- Premium Durum Butonu -->
<button id="premiumBtn" onclick="openPremiumModal()" class="bg-black/20 hover:bg-black/30 backdrop-blur-sm px-3 py-1.5 rounded-lg text-xs font-bold shadow transition flex items-center border border-white/20">
<i class="fa-solid fa-crown text-yellow-400 mr-1.5"></i> <span id="premiumText">Pro'ya Geç</span>
</button>
</div>
</header>
<!-- Tab Menü -->
<nav class="bg-white shadow-sm z-10 border-b border-slate-100">
<div class="flex max-w-3xl mx-auto">
<button onclick="switchTab('calendar')" id="tab-calendar" class="flex-1 py-3 text-center font-bold text-sm tab-active transition">
<i class="fa-regular fa-calendar-days mb-1 block"></i> Takvim
</button>
<button onclick="switchTab('doctors')" id="tab-doctors" class="flex-1 py-3 text-center font-bold text-sm tab-inactive transition">
<i class="fa-solid fa-user-nurse mb-1 block"></i> Personel
</button>
<button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-3 text-center font-bold text-sm tab-inactive transition">
<i class="fa-solid fa-sliders mb-1 block"></i> Ayarlar
</button>
</div>
</nav>
<!-- Ana İçerik Alanı -->
<main class="flex-1 overflow-y-auto p-4 max-w-3xl mx-auto w-full relative pb-24">
<!-- 1. TAKVİM GÖRÜNÜMÜ -->
<div id="view-calendar" class="space-y-4">
<div class="flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
<button onclick="changeMonth(-1)" class="p-2 text-red-600 hover:bg-red-50 rounded-full transition"><i class="fa-solid fa-chevron-left"></i></button>
<h2 id="currentMonthLabel" class="text-lg font-bold text-slate-800">Ekim 2023</h2>
<button onclick="changeMonth(1)" class="p-2 text-red-600 hover:bg-red-50 rounded-full transition"><i class="fa-solid fa-chevron-right"></i></button>
</div>
<div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
<div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-500 mb-2 border-b border-slate-100 pb-2">
<div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div class="text-red-500">Paz</div>
</div>
<div id="calendarGrid" class="grid grid-cols-7 gap-1.5"></div>
</div>
<div class="text-xs text-center text-slate-400 mt-2 flex justify-center gap-4">
<div class="flex items-center"><span class="w-2.5 h-2.5 bg-red-100 border border-red-300 rounded-full mr-1.5"></span> Eksik/Hata</div>
<div class="flex items-center"><span class="w-2.5 h-2.5 bg-green-100 border border-green-300 rounded-full mr-1.5"></span> Tamam</div>
</div>
</div>
<!-- 2. PERSONEL YÖNETİMİ -->
<div id="view-doctors" class="hidden space-y-4">
<div class="glass-card p-5 rounded-2xl shadow-sm border-l-4 border-red-500">
<h3 class="font-bold text-red-600 mb-3 flex items-center">
<i class="fa-solid fa-user-plus mr-2"></i> Yeni Personel Ekle
</h3>
<input type="text" id="docNameInput" placeholder="Ad Soyad (Örn: Uzm.Dr Feride GÜL)" class="w-full p-3 rounded-xl border border-slate-200 mb-4 focus:outline-none focus:ring-2 focus:ring-red-500 transition bg-slate-50">
<p class="text-xs text-slate-500 mb-2 font-medium">Nöbet Tercihleri:</p>
<div class="flex gap-2 text-[10px] mb-2">
<span class="bg-green-100 text-green-700 px-2 py-1 rounded">1 Tık: İstiyor</span>
<span class="bg-red-100 text-red-700 px-2 py-1 rounded">2 Tık: İstemiyor</span>
</div>
<div class="bg-white p-3 rounded-xl border border-slate-200 mb-4">
<div class="flex justify-between mb-2 px-1">
<button onclick="changePrefMonth(-1)" class="text-xs px-2"><i class="fa-solid fa-chevron-left"></i></button>
<span id="prefMonthLabel" class="text-xs font-bold text-slate-600">Ay</span>
<button onclick="changePrefMonth(1)" class="text-xs px-2"><i class="fa-solid fa-chevron-right"></i></button>
</div>
<div id="prefGrid" class="grid grid-cols-7 gap-1"></div>
</div>
<button onclick="saveDoctor()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition active:scale-95">

                    Kaydet
</button>
</div>
<div class="flex justify-between items-end">
<h3 class="font-bold text-slate-700 ml-1">Kayıtlı Personel</h3>
<span id="docCountBadge" class="text-[10px] bg-slate-200 px-2 py-1 rounded-full text-slate-600">0/3 (Ücretsiz)</span>
</div>
<ul id="doctorsList" class="space-y-2"></ul>
</div>
<!-- 3. AYARLAR -->
<div id="view-settings" class="hidden space-y-4">
<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
<h3 class="font-bold text-slate-700 mb-2 flex items-center">
<i class="fa-solid fa-list-check mr-2 text-red-500"></i> Nöbet Sahaları
</h3>
<p class="text-xs text-slate-500 mb-4">Nöbet yerlerini ve kişi sayılarını buradan yönetebilirsiniz.</p>
<div id="slotsConfigList" class="space-y-3"></div>
<button onclick="addNewSlot()" class="w-full mt-4 py-3 border-2 border-dashed border-slate-300 text-slate-500 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-700 transition">
<i class="fa-solid fa-plus mr-1"></i> Yeni Saha Ekle
</button>
<div class="h-px bg-slate-100 my-6"></div>
<!-- Rapor Butonu (Sadece Pro) -->
<div id="reportArea" class="mb-4">
<button onclick="downloadReport()" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
<i class="fa-solid fa-file-excel"></i> Excel Raporu İndir
</button>
<p class="text-[10px] text-center text-slate-400 mt-2">* Sadece Pro sürümde indirilebilir.</p>
</div>
<button onclick="saveSettings()" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-slate-900 transition">

                    Ayarları Güncelle
</button>
<div class="mt-6 text-center">
<button onclick="clearAllSystem()" class="text-xs text-red-500 hover:text-red-700 font-medium underline">

                        Tüm Verileri Sıfırla
</button>
</div>
</div>
</div>
</main>
<!-- Footer (ATATÜRK) -->
<footer class="bg-white border-t border-slate-200 p-6 text-center z-10 safe-area-pb">
<div class="max-w-md mx-auto">
<div class="inline-block shadow-md mb-2">
<img src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Flag_of_Turkey.svg" alt="Türkiye" class="h-6 w-auto rounded-[2px]">
</div>
<p class="text-slate-600 italic font-serif text-sm">"Beni Türk hekimlerine emanet ediniz."</p>
<p class="text-slate-900 font-bold text-xs mt-1 tracking-widest uppercase">ATATÜRK</p>
</div>
</footer>
<!-- NÖBET ATAMA MODALI -->
<div id="dayModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-end sm:items-center justify-center z-50">
<div class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('dayModal')"></div>
<div class="modal-container bg-white w-full max-w-md mx-auto rounded-t-3xl sm:rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] flex flex-col">
<div class="bg-red-600 p-4 text-white rounded-t-3xl sm:rounded-t-2xl sticky top-0 z-10 flex justify-between items-center shadow-md">
<div>
<h3 id="modalDateTitle" class="text-lg font-bold">Tarih</h3>
<p class="text-xs text-red-100">Personel Atama Ekranı</p>
</div>
<button onclick="closeModal('dayModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
</div>
<div class="p-4 space-y-4 flex-1 bg-slate-50">
<div id="modalWarnings" class="hidden bg-amber-50 border border-amber-200 text-amber-800 text-xs p-3 rounded-xl shadow-sm"></div>
<div id="modalSlotsArea" class="space-y-4"></div>
</div>
<div class="p-4 border-t bg-white sticky bottom-0 safe-area-pb">
<button onclick="closeModal('dayModal')" class="w-full bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 active:scale-95 transition">Tamam</button>
</div>
</div>
</div>
<!-- İSTATİSTİK MODALI -->
<div id="statsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-end sm:items-center justify-center z-50">
<div class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('statsModal')"></div>
<div class="modal-container bg-white w-full max-w-md mx-auto rounded-t-3xl sm:rounded-2xl shadow-2xl z-50 overflow-hidden flex flex-col">
<div class="bg-slate-800 p-4 text-white rounded-t-3xl sm:rounded-t-2xl flex justify-between items-center">
<h3 id="statsDocTitle" class="text-lg font-bold">İstatistikler</h3>
<button onclick="closeModal('statsModal')" class="text-white hover:bg-slate-700 p-2 rounded-full"><i class="fa-solid fa-xmark"></i></button>
</div>
<div id="statsContent" class="p-5 overflow-y-auto max-h-[80vh] bg-slate-50"></div>
</div>
</div>
<!-- PREMIUM SATIN ALMA MODALI -->
<div id="premiumModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 px-4">
<div class="modal-overlay absolute w-full h-full bg-slate-900/80 backdrop-blur-sm" onclick="closeModal('premiumModal')"></div>
<div class="modal-container bg-white w-full max-w-sm mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden relative transform transition-all scale-95">
<div class="h-32 premium-gradient flex items-center justify-center relative overflow-hidden">
<i class="fa-solid fa-crown text-6xl text-white/30 absolute"></i>
<h2 class="text-3xl font-bold text-white relative z-10 drop-shadow-md">MediNöbet PRO</h2>
</div>
<div class="p-6 text-center">
<p class="text-slate-600 mb-6 text-sm">Ücretsiz sürümde sınırlı erişiminiz bulunmaktadır. Sınırsız kullanım için Pro'ya geçin.</p>
<ul class="text-left space-y-3 mb-8 text-sm">
<li class="flex items-center gap-3"><i class="fa-solid fa-check text-green-500"></i> Sınırsız Personel Ekleme</li>
<li class="flex items-center gap-3"><i class="fa-solid fa-check text-green-500"></i> Sınırsız Nöbet Sahası</li>
<li class="flex items-center gap-3"><i class="fa-solid fa-check text-green-500"></i> Excel Raporu İndirme</li>
<li class="flex items-center gap-3"><i class="fa-solid fa-check text-green-500"></i> Reklamsız Deneyim</li>
</ul>
<button onclick="buyPro()" class="w-full premium-gradient text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-95 text-lg flex items-center justify-center gap-2">
<span>399.99 ₺</span> <span class="text-xs opacity-80 font-normal">(Tek Seferlik)</span>
</button>
<button onclick="closeModal('premiumModal')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">Hayır, teşekkürler</button>
</div>
</div>
</div>
<script>

        // --- LİSANS VE AYARLAR ---

        // LocalStorage'da 'isPremium' true ise kilitler açılır.

        let isPremium = localStorage.getItem('mediIsPremium') === 'true';

        // Limitler

        const FREE_DOC_LIMIT = 3;

        const FREE_SLOT_LIMIT = 3;

        let currentDate = new Date();

        let currentPrefDate = new Date();

        let settings = JSON.parse(localStorage.getItem('mediSettings')) || {

            slots: [

                { id: 1, name: "Servis", min: 1, max: 2 },

                { id: 2, name: "Acil", min: 1, max: 2 },

                { id: 3, name: "Triyaj", min: 1, max: 1 }

            ]

        };

        let doctors = JSON.parse(localStorage.getItem('mediDoctors')) || [];

        let assignments = JSON.parse(localStorage.getItem('mediAssignments')) || {};

        let editingDoc = { id: null, name: "", prefs: {} };

        // --- BAŞLANGIÇ ---

        document.addEventListener('DOMContentLoaded', () => {

            checkProStatus();

            renderCalendar();

            renderSettings();

            renderDoctorsList();

            renderPrefCalendar();

        });

        // --- PRO KONTROLLERİ ---

        function checkProStatus() {

            const btn = document.getElementById('premiumBtn');

            const reportBtn = document.querySelector('#reportArea button');

            const reportMsg = document.querySelector('#reportArea p');

            if(isPremium) {

                btn.innerHTML = `<i class="fa-solid fa-check-circle text-green-400 mr-1.5"></i> <span class="text-green-100">Pro Aktif</span>`;

                btn.onclick = null; // Butonu devre dışı bırak veya bilgi modalı aç

                // Rapor butonunu aç

                if(reportBtn) {

                    reportBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                    reportBtn.disabled = false;

                }

                if(reportMsg) reportMsg.style.display = 'none';

            } else {

                // Rapor butonunu kilitle

                if(reportBtn) {

                    reportBtn.classList.add('opacity-50', 'cursor-not-allowed');

                    reportBtn.disabled = true;

                    reportBtn.innerHTML = `<i class="fa-solid fa-lock mr-2"></i> Excel Raporu (Pro)`;

                }

            }

            updateLimitsUI();

        }

        function openPremiumModal() {

            if(isPremium) return;

            document.getElementById('premiumModal').classList.remove('opacity-0', 'pointer-events-none');

            document.querySelector('#premiumModal .modal-container').classList.remove('scale-95');

            document.querySelector('#premiumModal .modal-container').classList.add('scale-100');

        }

        function buyPro() {

            // BURASI SİMÜLASYON: Gerçekte Apple IAP entegrasyonu gerekir.

            if(confirm("Simülasyon: Satın alma işlemi başarılı kabul edilsin mi?")) {

                isPremium = true;

                localStorage.setItem('mediIsPremium', 'true');

                closeModal('premiumModal');

                alert("Teşekkürler! MediNöbet Pro özellikleri aktif edildi.");

                checkProStatus(); // Arayüzü güncelle

                location.reload(); // Temiz başlangıç

            }

        }

        function updateLimitsUI() {

            const badge = document.getElementById('docCountBadge');

            if(badge) {

                if(isPremium) {

                    badge.textContent = `${doctors.length} Personel (Sınırsız)`;

                    badge.className = "text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full border border-yellow-200";

                } else {

                    badge.textContent = `${doctors.length}/${FREE_DOC_LIMIT} (Ücretsiz)`;

                    badge.className = doctors.length >= FREE_DOC_LIMIT ? "text-[10px] bg-red-100 text-red-700 px-2 py-1 rounded-full font-bold" : "text-[10px] bg-slate-200 px-2 py-1 rounded-full text-slate-600";

                }

            }

        }

        // --- TAB YÖNETİMİ ---

        function switchTab(tabName) {

            document.getElementById('view-calendar').classList.add('hidden');

            document.getElementById('view-doctors').classList.add('hidden');

            document.getElementById('view-settings').classList.add('hidden');

            ['calendar', 'doctors', 'settings'].forEach(t => {

                const btn = document.getElementById(`tab-${t}`);

                if(t === tabName) {

                    btn.classList.remove('tab-inactive');

                    btn.classList.add('tab-active');

                    document.getElementById(`view-${t}`).classList.remove('hidden');

                } else {

                    btn.classList.remove('tab-active');

                    btn.classList.add('tab-inactive');

                }

            });

            if(tabName === 'calendar') renderCalendar();

            if(tabName === 'doctors') {

                editingDoc = { id: null, name: "", prefs: {} };

                document.getElementById('docNameInput').value = "";

                renderPrefCalendar();

                updateLimitsUI();

            }

        }

        // --- TAKVİM MANTIĞI ---

        function changeMonth(dir) {

            currentDate.setMonth(currentDate.getMonth() + dir);

            renderCalendar();

        }

        function renderCalendar() {

            const grid = document.getElementById('calendarGrid');

            const lbl = document.getElementById('currentMonthLabel');

            grid.innerHTML = '';

            const year = currentDate.getFullYear();

            const month = currentDate.getMonth();

            lbl.textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let startOffset = firstDay === 0 ? 6 : firstDay - 1;

            for(let i=0; i<startOffset; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++) {

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                const dateObj = new Date(year, month, d);

                const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'short' }); 

                const status = validateDayStatus(dateStr);

                let statusClass = 'status-neutral';

                if(status === 'error') statusClass = 'status-error';

                else if(status === 'ok') statusClass = 'status-ok';

                let assignedNames = [];

                if(assignments[dateStr]) {

                    Object.values(assignments[dateStr]).forEach(docs => {

                        if(Array.isArray(docs)) assignedNames.push(...docs);

                    });

                }

                let namesHtml = '';

                if(assignedNames.length > 0) {

                    namesHtml = `<div class="w-full mt-1 flex flex-col gap-1 overflow-y-auto no-scrollbar" style="max-height: 100%;">`;

                    [...new Set(assignedNames)].forEach(name => {

                        namesHtml += `
<div class="flex items-center justify-between bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 group">
<span class="text-[9px] font-medium text-slate-700 truncate">${name}</span>
<button onclick="deleteAssignment(event, '${dateStr}', '${name}')" class="text-red-400 hover:text-red-600 text-[10px] w-3 h-3 flex items-center justify-center">
<i class="fa-solid fa-times"></i>
</button>
</div>`;

                    });

                    namesHtml += `</div>`;

                }

                const dayDiv = document.createElement('div');

                dayDiv.className = `cal-day ${statusClass}`;

                dayDiv.innerHTML = `
<div class="flex justify-between w-full items-baseline border-b border-black/5 pb-1 mb-1 shrink-0">
<span class="font-bold text-sm leading-none text-slate-700">${d}</span>
<span class="text-[9px] font-bold uppercase text-slate-400 leading-none">${dayName}</span>
</div>

                    ${namesHtml}

                `;

                if(status === 'error') dayDiv.innerHTML += `<span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>`;

                dayDiv.onclick = () => openDayModal(dateStr);

                grid.appendChild(dayDiv);

            }

        }

        function deleteAssignment(e, dateStr, docName) {

            e.stopPropagation(); 

            if(!confirm(`${docName} adlı personeli ${dateStr} tarihinden silmek istiyor musunuz?`)) return;

            if (assignments[dateStr]) {

                let changed = false;

                Object.keys(assignments[dateStr]).forEach(slotKey => {

                    if (assignments[dateStr][slotKey].includes(docName)) {

                        assignments[dateStr][slotKey] = assignments[dateStr][slotKey].filter(n => n !== docName);

                        changed = true;

                    }

                });

                if (changed) {

                    localStorage.setItem('mediAssignments', JSON.stringify(assignments));

                    renderCalendar(); 

                }

            }

        }

        function validateDayStatus(dateStr) {

            if(!assignments[dateStr]) return 'neutral'; 

            let dayAssigns = assignments[dateStr];

            let isOk = true;

            let hasAny = false;

            settings.slots.forEach(slot => {

                const assignedCount = (dayAssigns[`slot${slot.id}`] || []).length;

                if(assignedCount > 0) hasAny = true;

                if(assignedCount < slot.min || assignedCount > slot.max) isOk = false;

            });

            if(!hasAny) return 'neutral';

            return isOk ? 'ok' : 'error';

        }

        // --- MODAL VE ATAMA ---

        let selectedDateStr = "";

        function openDayModal(dateStr) {

            selectedDateStr = dateStr;

            const dateObj = new Date(dateStr);

            document.getElementById('modalDateTitle').textContent = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });

            document.getElementById('dayModal').classList.remove('opacity-0', 'pointer-events-none');

            document.body.classList.add('modal-active');

            renderModalSlots();

        }

        function closeModal(modalId) {

            document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');

            if(modalId === 'premiumModal') {

                 document.querySelector('#premiumModal .modal-container').classList.remove('scale-100');

                 document.querySelector('#premiumModal .modal-container').classList.add('scale-95');

            }

            document.body.classList.remove('modal-active');

            if(modalId === 'dayModal') renderCalendar();

        }

        function renderModalSlots() {

            const container = document.getElementById('modalSlotsArea');

            container.innerHTML = '';

            let dayAssigns = assignments[selectedDateStr] || {};

            let warnings = [];

            let sortedDoctors = [...doctors].sort((a, b) => {

                const prefA = a.prefs[selectedDateStr] || 0;

                const prefB = b.prefs[selectedDateStr] || 0;

                const getWeight = (p) => p === 1 ? 0 : (p === 0 ? 1 : 2);

                return getWeight(prefA) - getWeight(prefB);

            });

            settings.slots.forEach(slot => {

                const currentDocs = dayAssigns[`slot${slot.id}`] || [];

                const slotDiv = document.createElement('div');

                slotDiv.className = "border border-slate-200 rounded-xl p-3 bg-white shadow-sm";

                let countColor = "text-slate-500";

                if(currentDocs.length < slot.min) { countColor = "text-red-600 font-bold"; warnings.push(`${slot.name}: Eksik personel.`); }

                else if(currentDocs.length > slot.max) { countColor = "text-red-600 font-bold"; warnings.push(`${slot.name}: Fazla personel.`); }

                else if(currentDocs.length > 0) { countColor = "text-green-600 font-bold"; }

                slotDiv.innerHTML = `
<div class="flex justify-between items-center mb-2.5">
<span class="font-bold text-sm text-slate-800">${slot.name}</span>
<span class="text-xs ${countColor} bg-slate-100 px-2 py-0.5 rounded-full">(${currentDocs.length} / ${slot.min}-${slot.max})</span>
</div>

                `;

                const buttonsDiv = document.createElement('div');

                buttonsDiv.className = "flex flex-wrap gap-2";

                sortedDoctors.forEach(doc => {

                    const isAssignedHere = currentDocs.includes(doc.name);

                    const pref = doc.prefs[selectedDateStr] || 0; 

                    let btnClass = "px-3 py-2 rounded-lg text-xs border transition flex items-center gap-1.5 font-medium ";

                    let icon = "";

                    if(isAssignedHere) {

                        btnClass += "bg-red-600 text-white border-red-600 shadow-md transform scale-105";

                        icon = `<i class="fa-solid fa-check"></i>`;

                    } else {

                        btnClass += "bg-white text-slate-600 border-slate-200 hover:bg-slate-50";

                    }

                    if(pref === 1) icon += `<i class="fa-solid fa-star text-yellow-400"></i>`;

                    if(pref === 2) icon += `<i class="fa-solid fa-ban text-red-400"></i>`;

                    const btn = document.createElement('button');

                    btn.className = btnClass;

                    btn.innerHTML = `${icon} ${doc.name}`;

                    btn.onclick = () => toggleAssignment(slot.id, doc.name);

                    buttonsDiv.appendChild(btn);

                });

                slotDiv.appendChild(buttonsDiv);

                container.appendChild(slotDiv);

            });

            const warnBox = document.getElementById('modalWarnings');

            if(warnings.length > 0) {

                warnBox.classList.remove('hidden');

                warnBox.innerHTML = `<strong>Durum:</strong><ul class="list-disc list-inside mt-1">${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;

            } else {

                warnBox.classList.add('hidden');

            }

        }

        function toggleAssignment(slotId, docName) {

            if(!assignments[selectedDateStr]) assignments[selectedDateStr] = {};

            let slotKey = `slot${slotId}`;

            let current = assignments[selectedDateStr][slotKey] || [];

            if(current.includes(docName)) {

                current = current.filter(n => n !== docName);

            } else {

                settings.slots.forEach(s => {

                    let k = `slot${s.id}`;

                    if(assignments[selectedDateStr][k] && assignments[selectedDateStr][k].includes(docName)) {

                        assignments[selectedDateStr][k] = assignments[selectedDateStr][k].filter(n => n !== docName);

                    }

                });

                current.push(docName);

            }

            assignments[selectedDateStr][slotKey] = current;

            localStorage.setItem('mediAssignments', JSON.stringify(assignments));

            renderModalSlots();

        }

        // --- PERSONEL YÖNETİMİ ---

        function changePrefMonth(dir) {

            currentPrefDate.setMonth(currentPrefDate.getMonth() + dir);

            renderPrefCalendar();

        }

        function renderPrefCalendar() {

            const grid = document.getElementById('prefGrid');

            const lbl = document.getElementById('prefMonthLabel');

            grid.innerHTML = '';

            const year = currentPrefDate.getFullYear();

            const month = currentPrefDate.getMonth();

            lbl.textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let startOffset = firstDay === 0 ? 6 : firstDay - 1;

            for(let i=0; i<startOffset; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++) {

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                const pref = editingDoc.prefs[dateStr] || 0;

                const dayDiv = document.createElement('div');

                let colorClass = "bg-white text-slate-600 border border-slate-100";

                if(pref === 1) colorClass = "pref-wanted";

                if(pref === 2) colorClass = "pref-blocked";

                dayDiv.className = `h-8 flex items-center justify-center rounded cursor-pointer text-xs font-bold ${colorClass}`;

                dayDiv.textContent = d;

                dayDiv.onclick = () => {

                    let next = (pref + 1) % 3;

                    if(next === 0) delete editingDoc.prefs[dateStr];

                    else editingDoc.prefs[dateStr] = next;

                    renderPrefCalendar();

                };

                grid.appendChild(dayDiv);

            }

        }

        function saveDoctor() {

            const nameInput = document.getElementById('docNameInput');

            const name = nameInput.value.trim(); 

            if(!name) { alert('Lütfen isim giriniz.'); return; }

            // FREE LİMİT KONTROLÜ

            if (!isPremium && !editingDoc.id && doctors.length >= FREE_DOC_LIMIT) {

                openPremiumModal();

                return;

            }

            const formattedName = name; 

            if(editingDoc.id) {

                const idx = doctors.findIndex(d => d.id === editingDoc.id);

                doctors[idx] = { ...editingDoc, name: formattedName };

            } else {

                doctors.push({ id: Date.now(), name: formattedName, prefs: editingDoc.prefs });

            }

            localStorage.setItem('mediDoctors', JSON.stringify(doctors));

            document.getElementById('docNameInput').value = "";

            editingDoc = { id: null, name: "", prefs: {} };

            renderPrefCalendar();

            renderDoctorsList();

            updateLimitsUI();

            alert('Kaydedildi!');

        }

        function editDoctor(id) {

            const doc = doctors.find(d => d.id === id);

            if(doc) {

                editingDoc = JSON.parse(JSON.stringify(doc));

                document.getElementById('docNameInput').value = doc.name;

                renderPrefCalendar();

                document.querySelector('main').scrollTop = 0;

            }

        }

        function deleteDoctor(id) {

            if(confirm('Personel silinecek?')) {

                doctors = doctors.filter(d => d.id !== id);

                localStorage.setItem('mediDoctors', JSON.stringify(doctors));

                renderDoctorsList();

                updateLimitsUI();

            }

        }

        function showDoctorStats(docName) {

            document.getElementById('statsDocTitle').textContent = `${docName} - Özet`;

            let stats = { total: 0, weekdays: 0, friday: 0, saturday: 0, sunday: 0, slots: {} };

            settings.slots.forEach(s => stats.slots[s.name] = 0);

            Object.keys(assignments).forEach(dateStr => {

                let workedToday = false;

                settings.slots.forEach(s => {

                    if(assignments[dateStr][`slot${s.id}`]?.includes(docName)) {

                        stats.slots[s.name]++;

                        workedToday = true;

                    }

                });

                if(workedToday) {

                    stats.total++;

                    const d = new Date(dateStr);

                    const day = d.getDay(); 

                    if(day === 5) stats.friday++;

                    else if(day === 6) stats.saturday++;

                    else if(day === 0) stats.sunday++;

                    else stats.weekdays++;

                }

            });

            let html = `
<div class="grid grid-cols-2 gap-3 mb-4">
<div class="bg-red-50 p-4 rounded-xl border border-red-100 text-center shadow-sm">
<div class="text-3xl font-bold text-red-600">${stats.total}</div>
<div class="text-xs text-red-400 font-bold uppercase mt-1">Toplam Nöbet</div>
</div>
<div class="space-y-1.5 text-xs">
<div class="flex justify-between p-1.5 bg-slate-50 rounded border"><span>Haftaiçi:</span> <span class="font-bold">${stats.weekdays}</span></div>
<div class="flex justify-between p-1.5 bg-white rounded border border-purple-200 text-purple-700"><span>Cuma:</span> <span class="font-bold">${stats.friday}</span></div>
<div class="flex justify-between p-1.5 bg-white rounded border border-orange-200 text-orange-700"><span>Cumartesi:</span> <span class="font-bold">${stats.saturday}</span></div>
<div class="flex justify-between p-1.5 bg-white rounded border border-red-200 text-red-700"><span>Pazar:</span> <span class="font-bold">${stats.sunday}</span></div>
</div>
</div>
<h4 class="font-bold text-sm text-slate-700 mb-2 border-b pb-2">Görev Yeri Dağılımı</h4>
<div class="grid grid-cols-2 gap-2 text-xs">

            `;

            Object.entries(stats.slots).forEach(([slotName, count]) => {

                html += `
<div class="flex justify-between items-center bg-white p-2.5 rounded-lg border border-slate-100 shadow-sm">
<span class="text-slate-600 font-medium">${slotName}</span>
<span class="font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-800">${count}</span>
</div>`;

            });

            html += `</div>`;

            document.getElementById('statsContent').innerHTML = html;

            document.getElementById('statsModal').classList.remove('opacity-0', 'pointer-events-none');

            document.body.classList.add('modal-active');

        }

        function renderDoctorsList() {

            const list = document.getElementById('doctorsList');

            list.innerHTML = '';

            doctors.forEach(doc => {

                const li = document.createElement('li');

                li.className = "flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-slate-100";

                li.innerHTML = `
<div class="flex items-center gap-3 cursor-pointer hover:opacity-70 flex-1" onclick="showDoctorStats('${doc.name}')">
<div class="w-9 h-9 bg-red-50 text-red-600 rounded-full flex items-center justify-center font-bold text-sm border border-red-100">
<i class="fa-solid fa-user-nurse"></i>
</div>
<span class="font-bold text-slate-700 text-sm">${doc.name}</span>
</div>
<div class="flex gap-2">
<button onclick="editDoctor(${doc.id})" class="text-slate-400 hover:text-blue-500 p-2"><i class="fa-solid fa-pen"></i></button>
<button onclick="deleteDoctor(${doc.id})" class="text-slate-400 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
</div>

                `;

                list.appendChild(li);

            });

        }

        // --- AYARLAR (DİNAMİK SAHALAR) ---

        function renderSettings() {

            const list = document.getElementById('slotsConfigList');

            list.innerHTML = '';

            settings.slots.forEach((slot, index) => {

                const div = document.createElement('div');

                div.className = "flex gap-2 items-center text-sm p-3 bg-slate-50 rounded-xl border border-slate-100";

                div.innerHTML = `
<div class="flex flex-col flex-1 gap-1">
<input type="text" value="${slot.name}" onchange="updateSlot(${index}, 'name', this.value)" class="w-full bg-white border border-slate-200 rounded p-2 text-sm font-bold text-slate-700" placeholder="Saha Adı">
<div class="flex gap-2 items-center">
<span class="text-[10px] text-slate-400 uppercase">Min</span>
<input type="number" value="${slot.min}" onchange="updateSlot(${index}, 'min', this.value)" class="w-12 bg-white border border-slate-200 rounded p-1 text-center text-xs">
<span class="text-[10px] text-slate-400 uppercase">Max</span>
<input type="number" value="${slot.max}" onchange="updateSlot(${index}, 'max', this.value)" class="w-12 bg-white border border-slate-200 rounded p-1 text-center text-xs">
</div>
</div>
<button onclick="deleteSlot(${index})" class="text-slate-400 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>

                `;

                list.appendChild(div);

            });

        }

        function updateSlot(index, field, value) {

            if(field !== 'name') value = parseInt(value);

            settings.slots[index][field] = value;

        }

        function addNewSlot() {

            // FREE LİMİT KONTROLÜ

            if (!isPremium && settings.slots.length >= FREE_SLOT_LIMIT) {

                openPremiumModal();

                return;

            }

            const newId = settings.slots.length > 0 ? Math.max(...settings.slots.map(s => s.id)) + 1 : 1;

            settings.slots.push({ id: newId, name: "Yeni Saha", min: 1, max: 2 });

            renderSettings();

        }

        function deleteSlot(index) {

            if(confirm("Bu sahayı silmek istediğinize emin misiniz?")) {

                settings.slots.splice(index, 1);

                renderSettings();

            }

        }

        function saveSettings() {

            localStorage.setItem('mediSettings', JSON.stringify(settings));

            alert('Ayarlar kaydedildi.');

            renderCalendar(); 

        }

        function clearAllSystem() {

            if(confirm('TÜM PERSONEL VE NÖBETLER SİLİNECEK! Emin misiniz?')) {

                localStorage.removeItem('mediAssignments');

                localStorage.removeItem('mediDoctors');

                // Settings'i koruyalım veya sıfırlayalım, kullanıcı seçimi

                location.reload();

            }

        }

        // --- RAPORLAMA ---

        function downloadReport() {

            if(!isPremium) {

                openPremiumModal();

                return;

            }

            let csvContent = "\uFEFF"; 

            let headers = ["İSİM"];

            settings.slots.forEach(s => headers.push(s.name.toUpperCase()));

            headers.push("TOPLAM", "HAFTAİÇİ", "CUMA", "CUMARTESİ", "PAZAR");

            csvContent += headers.join(";") + "\n";

            const sortedDocs = [...doctors].sort((a, b) => a.name.localeCompare(b.name, 'tr'));

            sortedDocs.forEach(doc => {

                let stats = { total: 0, weekday: 0, friday: 0, saturday: 0, sunday: 0 };

                let slotCounts = {}; 

                settings.slots.forEach(s => slotCounts[`slot${s.id}`] = 0);

                Object.keys(assignments).forEach(dateStr => {

                    const d = new Date(dateStr);

                    const day = d.getDay(); 

                    let worked = false;

                    settings.slots.forEach(s => {

                        const assignedDocs = assignments[dateStr][`slot${s.id}`] || [];

                        if(assignedDocs.includes(doc.name)) {

                            slotCounts[`slot${s.id}`]++;

                            worked = true;

                        }

                    });

                    if(worked) {

                        stats.total++;

                        if(day === 5) stats.friday++;

                        else if(day === 6) stats.saturday++;

                        else if(day === 0) stats.sunday++;

                        else stats.weekday++;

                    }

                });

                let row = [`"${doc.name}"`];

                settings.slots.forEach(s => row.push(slotCounts[`slot${s.id}`]));

                row.push(stats.total, stats.weekday, stats.friday, stats.saturday, stats.sunday);

                csvContent += row.join(";") + "\n";

            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");

            link.setAttribute("href", url);

            link.setAttribute("download", "MediNobet_Raporu.csv");

            document.body.appendChild(link);

            link.click();

            document.body.removeChild(link);

        }

        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.register('sw.js')

                .then(reg => console.log('SW kayıt edildi:', reg.scope))

                .catch(err => console.log('SW kayıt hatası (Normal olabilir):', err));

        }
</script>
</body>
</html>

 
