<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ShiftZen</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ShiftZen">
<link rel="apple-touch-icon" href="icon.png">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="manifest" href="manifest.json">
<style>

        body { 

            font-family: 'Inter', sans-serif; 

            background-color: #f1f5f9; 

            -webkit-tap-highlight-color: transparent;

            padding-top: env(safe-area-inset-top);

            padding-bottom: env(safe-area-inset-bottom);

            height: 100vh;

            display: flex;

            flex-direction: column;

            overflow: hidden;

        }

        :root { --primary: #2563eb; --bg-card: #ffffff; }

        .tab-active { color: var(--primary); border-top: 3px solid var(--primary); background: #eff6ff; }

        .tab-inactive { color: #94a3b8; border-top: 3px solid transparent; }

        .cal-day { 

            display: flex; flex-direction: column; 

            background: white; border: 1px solid #e2e8f0; 

            border-radius: 6px; overflow: hidden; position: relative;

            cursor: pointer; transition: all 0.1s;

            min-height: 80px; 

        }

        @media (min-width: 768px) { .cal-day { min-height: 120px; } }

        .cal-day:active { border-color: var(--primary); transform: scale(0.98); }

        .cal-day.is-holiday { background-color: #fef2f2; border-color: #fecdd3; }

        .shift-box {

            flex: 1; border-top: 1px solid #f1f5f9; padding: 1px 2px;

            display: flex; flex-direction: column; justify-content: start;

            min-height: 0;

        }

        .shift-label { font-size: 7px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 1px; }

        .name-tag {

            font-size: 9px; line-height: 1.3; padding: 1px 4px; border-radius: 3px; 

            background: #f8fafc; border: 1px solid #cbd5e1; color: #334155;

            display: flex; justify-content: space-between; align-items: center;

            margin-bottom: 1px; white-space: nowrap; overflow: hidden;

        }

        .name-tag button { margin-left: 2px; color: #ef4444; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Takvim iÃ§i Scrollbar */

        #calendarGrid::-webkit-scrollbar { width: 4px; }

        #calendarGrid::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .pref-day-cell { height: 70px; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; background: white; }

        .pref-day-header { font-size: 10px; font-weight: bold; text-align: center; background: #f8fafc; color: #64748b; padding: 2px 0; border-bottom: 1px solid #e2e8f0; }

        .pref-shift { flex: 1; border-top: 1px solid #f1f5f9; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; transition: background 0.1s; }

        .pref-shift:first-child { border-top: none; }

        .pref-shift.wanted { background-color: #dcfce7; color: #166534; }

        .pref-shift.blocked { background-color: #fee2e2; color: #991b1b; }

        .modal { transition: opacity 0.2s ease, transform 0.2s ease; }

        body.modal-active { overflow: hidden; }

        .magic-btn { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); box-shadow: 0 4px 10px rgba(124, 58, 237, 0.3); }

        .premium-gradient { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; }

        .toggle-checkbox:checked { right: 0; border-color: #68D391; }

        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
</style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">
<!-- Ãœst Bar -->
<header class="bg-white border-b border-slate-200 p-3 z-20 flex-none shadow-sm">
<div class="flex justify-between items-center max-w-7xl mx-auto px-2">
<div class="flex items-center gap-3">
<div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
<i class="fa-solid fa-user-clock text-xl"></i>
</div>
<div>
<h1 class="text-lg font-bold leading-none text-slate-800 tracking-tight">ShiftZen</h1>
<p class="text-[10px] text-slate-500 font-medium mt-0.5">AkÄ±llÄ± vardiya ve nÃ¶bet yÃ¶netim sistem asistanÄ± - Generated with responsibility by ATAOL AI Techs</p>
</div>
</div>
<span id="currentModeBadge" class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded-md border border-slate-200">24 Saat</span>
</div>
</header>
<!-- Tab MenÃ¼ -->
<nav class="bg-white shadow-sm z-10 border-b border-slate-100 shrink-0">
<div class="flex w-full max-w-7xl mx-auto">
<button onclick="switchTab('calendar')" id="tab-calendar" class="flex-1 py-3 flex flex-col items-center justify-center text-xs sm:text-sm font-bold tab-active transition">
<i class="fa-regular fa-calendar-days text-lg mb-1"></i> Takvim
</button>
<button onclick="switchTab('doctors')" id="tab-doctors" class="flex-1 py-3 flex flex-col items-center justify-center text-xs sm:text-sm font-bold tab-inactive transition">
<i class="fa-solid fa-users text-lg mb-1"></i> Ekip
</button>
<button onclick="switchTab('stats')" id="tab-stats" class="flex-1 py-3 flex flex-col items-center justify-center text-xs sm:text-sm font-bold tab-inactive transition">
<i class="fa-solid fa-chart-pie text-lg mb-1"></i> Analiz
</button>
<button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-3 flex flex-col items-center justify-center text-xs sm:text-sm font-bold tab-inactive transition">
<i class="fa-solid fa-sliders text-lg mb-1"></i> Ayarlar
</button>
</div>
</nav>
<!-- Ana Ä°Ã§erik -->
<main class="flex-1 overflow-hidden relative w-full max-w-7xl mx-auto">
<div class="h-full w-full overflow-y-auto p-2 sm:p-4 pb-20 no-scrollbar" id="main-scroll">
<!-- 1. TAKVÄ°M -->
<div id="view-calendar" class="flex flex-col gap-3 h-full">
<div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-3 shrink-0">
<div class="flex items-center gap-4 bg-slate-50 p-1.5 rounded-lg border border-slate-100">
<button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-md shadow-sm text-slate-600 hover:text-blue-600"><i class="fa-solid fa-chevron-left"></i></button>
<h2 id="currentMonthLabel" class="text-sm font-bold text-slate-800 w-24 text-center">Ay</h2>
<button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-md shadow-sm text-slate-600 hover:text-blue-600"><i class="fa-solid fa-chevron-right"></i></button>
</div>
<button onclick="autoDistribute()" class="w-full sm:w-auto px-4 py-2 rounded-lg text-white text-xs font-bold flex items-center justify-center gap-2 magic-btn active:scale-95 transition">
<i class="fa-solid fa-wand-magic-sparkles"></i> AkÄ±llÄ± DaÄŸÄ±t
</button>
</div>
<div class="flex justify-center gap-4 text-[10px] text-slate-500 font-medium shrink-0">
<div class="flex items-center"><span class="w-2 h-2 bg-red-100 border border-red-300 rounded mr-1.5"></span> Eksik</div>
<div class="flex items-center"><span class="w-2 h-2 bg-green-100 border border-green-300 rounded mr-1.5"></span> Tamam</div>
<div class="flex items-center"><span class="w-2 h-2 bg-white border border-red-300 rounded mr-1.5"></span> Tatil</div>
</div>
<div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col flex-1 overflow-hidden">
<div class="grid grid-cols-7 border-b border-slate-100 bg-slate-50/50">
<div class="text-center py-2 text-[10px] font-bold text-slate-400">Pzt</div><div class="text-center py-2 text-[10px] font-bold text-slate-400">Sal</div><div class="text-center py-2 text-[10px] font-bold text-slate-400">Ã‡ar</div><div class="text-center py-2 text-[10px] font-bold text-slate-400">Per</div><div class="text-center py-2 text-[10px] font-bold text-slate-400">Cum</div><div class="text-center py-2 text-[10px] font-bold text-orange-500">Cmt</div><div class="text-center py-2 text-[10px] font-bold text-red-500">Paz</div>
</div>
<div id="calendarGrid" class="grid grid-cols-7 gap-px bg-slate-100 flex-1 overflow-y-auto no-scrollbar"></div>
</div>
</div>
<!-- 2. EKÄ°P (GÃœNCELLENDÄ°) -->
<div id="view-doctors" class="hidden space-y-4 max-w-2xl mx-auto">
<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200" id="doctorCard">
<!-- BaÅŸlÄ±k AlanÄ± -->
<div class="flex justify-between items-center mb-4">
<h3 class="font-bold text-slate-800 flex items-center">
<div class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center mr-2 text-xs"><i class="fa-solid fa-user-plus"></i></div>
<span id="docCardTitle">Yeni Personel Ekle</span>
</h3>
<!-- SÄ±fÄ±rla / Yeni Ekle Butonu (Gizli baÅŸlar) -->
<button onclick="resetDoctorForm()" id="btnResetDoc" class="hidden text-xs text-slate-400 hover:text-blue-600 flex items-center transition bg-slate-50 px-2 py-1 rounded border border-slate-100">
<i class="fa-solid fa-plus mr-1"></i> Yeni Ekle
</button>
</div>
<input type="text" id="docNameInput" placeholder="Ad SOYAD (Ã–rn. Uzm.Dr. Feride GÃœL)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm mb-4 focus:outline-none focus:border-blue-500 transition">
<div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
<div class="flex justify-between items-center mb-2 px-1">
<span class="text-xs font-bold text-slate-500">Vardiya/NÃ¶bet Tercihleri</span>
<div class="flex gap-2">
<button onclick="changePrefMonth(-1)" class="w-5 h-5 flex items-center justify-center bg-white rounded border text-xs"><i class="fa-solid fa-chevron-left"></i></button>
<span id="prefMonthLabel" class="text-[10px] font-bold py-1">Ay</span>
<button onclick="changePrefMonth(1)" class="w-5 h-5 flex items-center justify-center bg-white rounded border text-xs"><i class="fa-solid fa-chevron-right"></i></button>
</div>
</div>
<!-- GÃ¼n Ä°simleri -->
<div class="grid grid-cols-7 text-center mb-1">
<span class="text-[9px] font-bold text-slate-400">Pzt</span><span class="text-[9px] font-bold text-slate-400">Sal</span><span class="text-[9px] font-bold text-slate-400">Ã‡ar</span><span class="text-[9px] font-bold text-slate-400">Per</span><span class="text-[9px] font-bold text-slate-400">Cum</span><span class="text-[9px] font-bold text-orange-400">Cmt</span><span class="text-[9px] font-bold text-red-400">Paz</span>
</div>
<div id="prefGrid" class="grid grid-cols-7 gap-1"></div>
<p class="text-[10px] text-slate-400 mt-2 text-center">MÃ¼saitlik iÃ§in kutucuklara tÄ±klayÄ±n.</p>
</div>
<button onclick="saveDoctor()" id="btnSaveDoc" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-slate-800 transition text-sm">Kaydet</button>
</div>
<div class="space-y-2">
<h3 class="font-bold text-slate-700 text-sm ml-1">Ekip Listesi</h3>
<p class="text-[10px] text-slate-400 ml-1 mb-1">DÃ¼zenlemek iÃ§in isme tÄ±klayÄ±n.</p>
<ul id="doctorsList" class="grid grid-cols-1 gap-2"></ul>
</div>
</div>
<!-- 3. ANALÄ°Z -->
<div id="view-stats" class="hidden space-y-4 max-w-4xl mx-auto">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
<h4 class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">Genel YÃ¼k</h4>
<div class="h-48"><canvas id="totalChart"></canvas></div>
</div>
<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
<h4 class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">Tatil YÃ¼kÃ¼</h4>
<div class="h-48"><canvas id="weekendChart"></canvas></div>
</div>
</div>
<h3 class="font-bold text-slate-700 text-sm mt-4 ml-1">BÃ¶lge BazlÄ± Analiz</h3>
<div id="slotChartsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
<div class="h-px bg-slate-200 my-4"></div>
<button onclick="downloadFullReport()" class="w-full premium-gradient text-white font-bold py-4 rounded-xl shadow-lg shadow-green-100 hover:shadow-xl transition transform active:scale-95 flex items-center justify-center gap-3">
<div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-file-excel"></i></div>
<div class="text-left">
<div class="text-sm">Excel Raporu Ä°ndir</div>
<div class="text-[10px] opacity-80 font-normal">Tam Ã‡izelge + Ä°statistikler</div>
</div>
</button>
</div>
<!-- 4. AYARLAR -->
<div id="view-settings" class="hidden space-y-6 max-w-2xl mx-auto">
<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
<h3 class="font-bold text-slate-800 mb-2 flex items-center text-sm"><div class="w-6 h-6 rounded bg-green-100 text-green-600 flex items-center justify-center mr-2 text-xs"><i class="fa-solid fa-scale-balanced"></i></div>Adalet Terazisi</h3>
<p class="text-[10px] text-slate-500 mb-2">KÃ¼mÃ¼latif hesaplama baÅŸlangÄ±cÄ±:</p>
<div class="flex gap-2 items-center"><label class="text-xs font-bold text-slate-600">Tarih:</label><input type="date" id="cumulativeStartDate" class="border rounded p-2 text-xs bg-slate-50 flex-1" onchange="saveCumulativeDate()"></div>
</div>
<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
<h3 class="font-bold text-slate-800 mb-3 flex items-center text-sm"><div class="w-6 h-6 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center mr-2 text-xs"><i class="fa-solid fa-clock"></i></div>Ã‡alÄ±ÅŸma DÃ¼zeni</h3>
<div class="grid grid-cols-3 gap-2">
<button onclick="changeShiftMode(1)" id="mode-1" class="border p-3 rounded-xl text-center hover:bg-slate-50 transition flex flex-col items-center gap-1"><span class="font-bold text-xs">24 Saat</span></button>
<button onclick="changeShiftMode(2)" id="mode-2" class="border p-3 rounded-xl text-center hover:bg-slate-50 transition flex flex-col items-center gap-1"><span class="font-bold text-xs">12 Saat</span></button>
<button onclick="changeShiftMode(3)" id="mode-3" class="border p-3 rounded-xl text-center hover:bg-slate-50 transition flex flex-col items-center gap-1"><span class="font-bold text-xs">8 Saat</span></button>
</div>
</div>
<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800 text-sm flex items-center"><div class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center mr-2 text-xs"><i class="fa-solid fa-map-location-dot"></i></div>GÃ¶rev Yerleri</h3><button onclick="addNewSlot()" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg font-bold hover:bg-slate-200 transition">+ Ekle</button></div>
<div id="slotsConfigList" class="space-y-3"></div>
<button onclick="saveSettings()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-100 hover:bg-blue-700 transition text-sm mt-4">Kaydet</button>
</div>
<div class="grid grid-cols-2 gap-3">
<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200"><h4 class="font-bold text-xs text-slate-500 uppercase mb-2">Yedekleme (JSON formatÄ±nda)</h4><div class="flex gap-2"><button onclick="backupData()" class="flex-1 bg-blue-50 text-blue-600 border border-blue-100 rounded-lg text-xs font-bold hover:bg-blue-100 flex flex-col items-center justify-center py-2 transition h-14"><i class="fa-solid fa-download text-lg mb-1"></i> Ä°ndir</button><label class="flex-1 bg-orange-50 text-orange-600 border border-orange-100 rounded-lg text-xs font-bold hover:bg-orange-100 cursor-pointer flex flex-col items-center justify-center py-2 transition h-14"><i class="fa-solid fa-upload text-lg mb-1"></i> YÃ¼kle<input type="file" id="restoreInput" class="hidden" onchange="restoreData(this)"></label></div></div>
<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200"><h4 class="font-bold text-xs text-slate-500 uppercase mb-2">SÄ±fÄ±rlama</h4><button onclick="clearAllSystem()" class="w-full h-14 bg-red-50 text-red-600 font-bold rounded-lg border border-red-100 text-xs flex flex-col items-center justify-center hover:bg-red-100 transition"><i class="fa-solid fa-trash-can text-lg mb-1"></i>Temizle</button></div>
</div>
</div>
</div>
</main>
<footer class="bg-white border-t border-slate-200 p-2 text-center z-10 shrink-0 safe-area-pb absolute bottom-0 w-full">
<div class="flex items-center justify-center gap-2 opacity-80"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Flag_of_Turkey.svg" alt="TÃ¼rkiye" class="h-3 w-auto rounded-[1px] border border-slate-200"><p class="text-slate-600 italic font-serif text-[10px]">"VatanÄ±nÄ± en Ã§ok seven gÃ¶revini en iyi yapandÄ±r."</p><span class="text-slate-900 font-bold text-[9px] uppercase tracking-wider"ATATÃœRK</span></div>
</footer>
<!-- MODALLAR -->
<div id="dayModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-end sm:items-center justify-center"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('dayModal')"></div><div class="bg-white w-full max-w-lg mx-auto rounded-t-3xl sm:rounded-2xl shadow-2xl relative z-10 flex flex-col h-[85vh] sm:h-[600px]"><div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-3xl"><div><h3 id="modalDateTitle" class="text-lg font-bold text-slate-800">Tarih</h3><p class="text-xs text-slate-500">GÃ¶rev Atama</p></div><button onclick="closeModal('dayModal')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div><div class="px-4 py-2 bg-slate-50 border-b border-slate-100 flex justify-between items-center"><span class="text-xs font-bold text-slate-600 flex items-center gap-2"><i class="fa-solid fa-umbrella-beach text-orange-400"></i> Tatil/Haftasonu</span><div class="relative inline-block w-9 align-middle select-none"><input type="checkbox" id="holidayToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/><label for="holidayToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label></div></div><div id="modalShiftTabs" class="flex border-b border-slate-100 px-2 pt-2 bg-white hidden"></div><div class="p-4 overflow-y-auto flex-1 bg-slate-50/50"><div id="restWarningBox" class="hidden mb-3 bg-orange-50 text-orange-700 text-xs p-3 rounded-xl border border-orange-100 flex items-start gap-2"><i class="fa-solid fa-triangle-exclamation mt-0.5"></i><div><strong id="restingCount">0</strong> personel dinleniyor.</div></div><div id="modalSlotsArea" class="space-y-3"></div></div><div class="p-4 border-t border-slate-100 bg-white"><button onclick="closeModal('dayModal')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">Kaydet</button></div></div></div>
<div id="prefModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('prefModal')"></div><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl relative z-10 flex flex-col overflow-hidden m-4"><div class="bg-slate-800 p-4 text-white flex justify-between items-center"><h3 id="prefModalTitle" class="font-bold">Tercihler</h3><button onclick="closeModal('prefModal')" class="text-white/70 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div><div class="p-4 bg-slate-50 space-y-3" id="prefModalContent"></div><div class="p-3 border-t bg-white"><button onclick="closeModal('prefModal')" class="w-full bg-slate-800 text-white font-bold py-2 rounded-lg text-sm">Tamam</button></div></div></div>
<div id="statsModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-end sm:items-center justify-center"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('statsModal')"></div><div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-3xl shadow-2xl relative z-10 flex flex-col max-h-[80vh]"><div class="p-4 border-b border-slate-100 flex justify-between items-center"><h3 id="statsDocTitle" class="text-lg font-bold text-slate-800">Ä°statistik</h3><button onclick="closeModal('statsModal')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div><div id="statsContent" class="p-5 overflow-y-auto bg-slate-50"></div></div></div>
<script>

        let currentDate = new Date(); let currentPrefDate = new Date();

        let settings = JSON.parse(localStorage.getItem('mediSettings')) || { mode: 1, startDate: new Date().getFullYear()+'-01-01', slots: [{ id: 1, name: "BÃ¶lge 1", min_wd: 1, max_wd: 2, min_we: 1, max_we: 1 }, { id: 2, name: "BÃ¶lge 2", min_wd: 1, max_wd: 2, min_we: 1, max_we: 2 }] };

        if(!settings.mode) settings.mode=1; if(!settings.startDate) settings.startDate = new Date().getFullYear()+'-01-01';

        settings.slots = settings.slots.map(s => { if (s.min !== undefined) return { id: s.id, name: s.name, min_wd: s.min, max_wd: s.max, min_we: s.min, max_we: s.max }; return s; });

        let doctors = JSON.parse(localStorage.getItem('mediDoctors')) || [];

        let assignments = JSON.parse(localStorage.getItem('mediAssignments')) || {};

        if(Object.keys(assignments).length > 0) { let k = Object.keys(assignments)[0]; if(!assignments[k].shift1 && assignments[k].slot1) { let n = {}; Object.keys(assignments).forEach(dk => { n[dk] = { shift1: assignments[dk] }; }); assignments = n; localStorage.setItem('mediAssignments', JSON.stringify(assignments)); } }

        let officialHolidays = JSON.parse(localStorage.getItem('mediHolidays')) || []; 

        let editingDoc = { id: null, name: "", prefs: {} };

        let totalChart = null; let weekendChart = null; let slotCharts = {};

        const shiftLabels = { 1: ["Tek Vardiya/NÃ¶bet"], 2: ["08:00 - 20:00", "20:00 - 08:00"], 3: ["08:00 - 16:00", "16:00 - 24:00", "24:00 - 08:00"] };

        let statMode = 'monthly';

        document.addEventListener('DOMContentLoaded', () => { renderCalendar(); renderSettings(); updateModeUI(); renderDoctorsList(); renderPrefCalendar(); document.getElementById('cumulativeStartDate').value = settings.startDate; });

        function switchTab(tabName) {

            ['calendar', 'doctors', 'stats', 'settings'].forEach(t => { document.getElementById(`view-${t}`).classList.add('hidden'); document.getElementById(`tab-${t}`).className = `flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-400 transition tab-inactive`; });

            document.getElementById(`view-${tabName}`).classList.remove('hidden'); document.getElementById(`tab-${tabName}`).className = `flex-1 h-full flex flex-col items-center justify-center gap-1 text-blue-600 tab-active transition`;

            if(tabName === 'calendar') renderCalendar();

            if(tabName === 'stats') setTimeout(renderStats, 100);

            if(tabName === 'settings') { renderSettings(); updateModeUI(); }

            if(tabName === 'doctors') { resetDoctorForm(); renderPrefCalendar(); }

        }

        // --- EXCEL & DÄ°ÄžER ---

        function saveDoctor() { 

            const n = document.getElementById('docNameInput').value.trim(); 

            if(!n) return alert('Ä°sim girin'); 

            if(editingDoc.id) { 

                const i = doctors.findIndex(d=>d.id===editingDoc.id); 

                doctors[i] = {...editingDoc, name:n}; 

            } else { 

                doctors.push({id:Date.now(), name:n, prefs:editingDoc.prefs}); 

            } 

            localStorage.setItem('mediDoctors', JSON.stringify(doctors)); 

            resetDoctorForm(); // KayÄ±ttan sonra sÄ±fÄ±rla

            renderPrefCalendar(); 

            renderDoctorsList(); 

            // alert('Kaydedildi!'); // KullanÄ±cÄ± akÄ±ÅŸÄ±nÄ± kesmemek iÃ§in alert'i kaldÄ±rdÄ±m

        }

        function editDoctor(id) { 

            const d = doctors.find(d=>d.id===id); 

            if(d) { 

                editingDoc=JSON.parse(JSON.stringify(d)); 

                document.getElementById('docNameInput').value=d.name; 

                document.getElementById('docNameInput').focus();

                // DÃ¼zenleme Modu UI

                document.getElementById('docCardTitle').textContent = "Personel DÃ¼zenle";

                document.getElementById('btnResetDoc').classList.remove('hidden');

                document.getElementById('doctorCard').classList.add('border-blue-400', 'ring-2', 'ring-blue-100');

                document.getElementById('btnSaveDoc').textContent = "GÃ¼ncelle";

                renderPrefCalendar(); 

                document.querySelector('#main-scroll').scrollTop=0; 

                switchTab('doctors'); 

            } 

        }

        function resetDoctorForm() {

            editingDoc = { id: null, name: "", prefs: {} };

            document.getElementById('docNameInput').value = "";

            // Yeni Ekleme Modu UI

            document.getElementById('docCardTitle').textContent = "Yeni Personel Ekle";

            document.getElementById('btnResetDoc').classList.add('hidden');

            document.getElementById('doctorCard').classList.remove('border-blue-400', 'ring-2', 'ring-blue-100');

            document.getElementById('btnSaveDoc').textContent = "Kaydet";

            renderPrefCalendar();

        }

        function deleteDoctor(id) { if(confirm('Sil?')) { doctors=doctors.filter(d=>d.id!==id); localStorage.setItem('mediDoctors', JSON.stringify(doctors)); renderDoctorsList(); } }

        function renderDoctorsList() { 

            document.getElementById('doctorsList').innerHTML = doctors.map(d => `
<li class="flex justify-between bg-white p-3 rounded-xl shadow-sm border border-slate-100 cursor-pointer hover:bg-blue-50 transition" onclick="editDoctor(${d.id})">
<div class="flex items-center gap-3">
<div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">${d.name.charAt(0)}</div>
<span class="font-bold text-sm text-slate-700">${d.name}</span>
</div>
<div class="flex gap-2">
<button onclick="event.stopPropagation(); deleteDoctor(${d.id})" class="text-slate-400 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
</div>
</li>`).join(''); 

        }

        // --- (DÄ°ÄžER TÃœM FONKSÄ°YONLAR AYNI ÅžEKÄ°LDE DEVAM EDÄ°YOR - KISALIK Ä°Ã‡Ä°N TEKRARLAMADIM) ---

        // calculateStats, calculateSlotStats, saveCumulativeDate, changeShiftMode, updateModeUI

        // changeMonth, renderCalendar, isDayHoliday, getSlotLimit, validateDayStatus, toggleHoliday

        // changePrefMonth, renderPrefCalendar, openPrefModal, setPref

        // openDayModal, closeModal, renderModalSlots, toggleAssignment

        // autoDistribute, renderSettings, updateSlot, addNewSlot, deleteSlot, saveSettings, clearAllSystem, deleteAssignment

        // backupData, restoreData, renderStats, downloadFullReport

        // ... (Bu fonksiyonlar Ã¶nceki versiyondaki gibi kalacak) ...

        // --- EKSÄ°K FONKSÄ°YONLARI TAMAMLAYALIM (Hata almamak iÃ§in) ---

        function calculateStats(docName, isCumulative) { let total = 0; let weekend = 0; let startDateStr = settings.startDate; let monthPrefix = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`; Object.keys(assignments).forEach(dateStr => { if (isCumulative) { if (dateStr < startDateStr) return; } else { if (!dateStr.startsWith(monthPrefix)) return; } let w=false; let h=isDayHoliday(dateStr); for(let s=1; s<=settings.mode; s++) { if(assignments[dateStr][`shift${s}`]) Object.values(assignments[dateStr][`shift${s}`]).forEach(l=>{if(l.includes(docName)) w=true}); } if(w) { total++; if(h) weekend++; } }); return { total, weekend }; }

        function calculateSlotStats(docName, slotId, isCumulative) { let count = 0; let startDateStr = settings.startDate; let monthPrefix = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`; Object.keys(assignments).forEach(dateStr => { if (isCumulative) { if (dateStr < startDateStr) return; } else { if (!dateStr.startsWith(monthPrefix)) return; } for(let s=1; s<=settings.mode; s++) { if(assignments[dateStr][`shift${s}`] && assignments[dateStr][`shift${s}`][`slot${slotId}`]?.includes(docName)) count++; } }); return count; }

        function saveCumulativeDate() { const val = document.getElementById('cumulativeStartDate').value; if(val) { settings.startDate = val; localStorage.setItem('mediSettings', JSON.stringify(settings)); alert("Tarih kaydedildi."); } }

        function changeShiftMode(mode) { if(settings.mode !== mode) { if(confirm("Mod deÄŸiÅŸecek. Takvim gÃ¶rÃ¼nÃ¼mÃ¼ yenilenecek. OnaylÄ±yor musunuz?")) { settings.mode = mode; localStorage.setItem('mediSettings', JSON.stringify(settings)); updateModeUI(); renderCalendar(); } } }

        function updateModeUI() { [1, 2, 3].forEach(m => { const btn = document.getElementById(`mode-${m}`); if(settings.mode === m) btn.className = "border-2 border-blue-600 bg-blue-50 text-blue-700 p-2 rounded-xl text-center flex flex-col items-center gap-1 shadow-sm"; else btn.className = "border border-slate-200 p-2 rounded-xl text-center text-slate-400 hover:bg-slate-50 transition flex flex-col items-center gap-1"; }); }

        function changeMonth(dir) { currentDate.setMonth(currentDate.getMonth() + dir); renderCalendar(); }

        function renderCalendar() { const grid = document.getElementById('calendarGrid'); grid.innerHTML = ''; const year = currentDate.getFullYear(); const month = currentDate.getMonth(); document.getElementById('currentMonthLabel').textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' }); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); let startOffset = firstDay === 0 ? 6 : firstDay - 1; for(let i=0; i<startOffset; i++) grid.innerHTML += `<div></div>`; for(let d=1; d<=daysInMonth; d++) { const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const dateObj = new Date(year, month, d); const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'short' }); const isHoliday = isDayHoliday(dateStr); const status = validateDayStatus(dateStr); let bgClass = isHoliday ? 'is-holiday' : 'bg-white'; if(!isHoliday) { if(status === 'error') bgClass = 'bg-red-50 border-red-200'; else if(status === 'ok') bgClass = 'bg-green-50 border-green-200'; } let shiftsHtml = ''; for(let s=1; s<=settings.mode; s++) { let names = []; if(assignments[dateStr] && assignments[dateStr][`shift${s}`]) Object.values(assignments[dateStr][`shift${s}`]).forEach(list => names.push(...list)); names = [...new Set(names)]; let content = names.map(n => `<span class="name-tag">${n}</span>`).join(''); let label = settings.mode > 1 ? `<div class="shift-label">${s}. V</div>` : ""; shiftsHtml += `<div class="shift-box ${names.length===0?'bg-slate-50/50':''}">${label}<div class="flex flex-wrap gap-0.5 overflow-hidden cal-scroll" style="max-height:100%;overflow-y:auto;">${content}</div></div>`; } const div = document.createElement('div'); div.className = `cal-day ${bgClass}`; div.innerHTML = `<div class="flex justify-between w-full p-1 border-b border-black/5 shrink-0"><span class="font-bold text-xs text-slate-700">${d}</span></div><div class="flex flex-col flex-1 w-full h-full min-h-0">${shiftsHtml}</div>`; div.onclick = () => openDayModal(dateStr); grid.appendChild(div); } }

        function isDayHoliday(ds) { const d = new Date(ds); const day = d.getDay(); return day===0 || day===6 || officialHolidays.includes(ds); }

        function getSlotLimit(slot, ds) { return isDayHoliday(ds) ? { min: slot.min_we, max: slot.max_we } : { min: slot.min_wd, max: slot.max_wd }; }

        function validateDayStatus(ds) { if(!assignments[ds]) return 'neutral'; let isOk=true; let hasAny=false; for(let s=1; s<=settings.mode; s++) { if(assignments[ds][`shift${s}`]) { settings.slots.forEach(slot => { const limit = getSlotLimit(slot, ds); const c = (assignments[ds][`shift${s}`][`slot${slot.id}`]||[]).length; if(c>0) hasAny=true; if(c<limit.min || c>limit.max) isOk=false; }); } else if(settings.slots.some(sl => sl.min_wd>0)) isOk=false; } return !hasAny ? 'neutral' : (isOk ? 'ok' : 'error'); }

        function toggleHoliday(ds) { if(officialHolidays.includes(ds)) officialHolidays = officialHolidays.filter(d=>d!==ds); else officialHolidays.push(ds); localStorage.setItem('mediHolidays', JSON.stringify(officialHolidays)); renderCalendar(); renderStats(); }

        function changePrefMonth(dir) { currentPrefDate.setMonth(currentPrefDate.getMonth() + dir); renderPrefCalendar(); }

        function renderPrefCalendar() { const grid = document.getElementById('prefGrid'); grid.innerHTML = ''; const year = currentPrefDate.getFullYear(); const month = currentPrefDate.getMonth(); document.getElementById('prefMonthLabel').textContent = new Date(year, month).toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' }); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); let startOffset = firstDay === 0 ? 6 : firstDay - 1; for(let i=0; i<startOffset; i++) grid.innerHTML += `<div></div>`; for(let d=1; d<=daysInMonth; d++) { const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const div = document.createElement('div'); div.className = "pref-day-cell"; const header = document.createElement('div'); header.className = "pref-day-header"; header.textContent = d; div.appendChild(header); for(let s=1; s<=settings.mode; s++) { const shiftDiv = document.createElement('div'); shiftDiv.className = "pref-shift"; const pref = (editingDoc.prefs[ds] && editingDoc.prefs[ds][s]) || 0; if(pref === 1) { shiftDiv.classList.add('wanted'); shiftDiv.textContent = "âœ“"; } if(pref === 2) { shiftDiv.classList.add('blocked'); shiftDiv.textContent = "âœ•"; } shiftDiv.onclick = () => { let next = (pref + 1) % 3; if(!editingDoc.prefs[ds]) editingDoc.prefs[ds] = {}; if(next === 0) delete editingDoc.prefs[ds][s]; else editingDoc.prefs[ds][s] = next; renderPrefCalendar(); }; div.appendChild(shiftDiv); } grid.appendChild(div); } }

        function openPrefModal(ds) { document.getElementById('prefModalTitle').textContent = `Tercihler: ${ds}`; const content = document.getElementById('prefModalContent'); content.innerHTML = ''; const labels = shiftLabels[settings.mode]; for(let s=1; s<=settings.mode; s++) { const currentPref = (editingDoc.prefs[ds] && editingDoc.prefs[ds][s]) || 0; const row = document.createElement('div'); row.className = "flex items-center justify-between bg-white p-2 rounded border"; row.innerHTML = `<span class="text-xs font-bold text-slate-600">${labels[s-1]}</span><div class="flex gap-1"><button onclick="setPref('${ds}', ${s}, 0)" class="w-6 h-6 rounded ${currentPref===0?'bg-slate-200 border-slate-400 border':''} text-xs">âšª</button><button onclick="setPref('${ds}', ${s}, 1)" class="w-6 h-6 rounded ${currentPref===1?'bg-green-100 border-green-500 border':''} text-xs">ðŸŸ¢</button><button onclick="setPref('${ds}', ${s}, 2)" class="w-6 h-6 rounded ${currentPref===2?'bg-red-100 border-red-500 border':''} text-xs">ðŸ”´</button></div>`; content.appendChild(row); } document.getElementById('prefModal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); }

        window.setPref = function(ds, s, val) { if(!editingDoc.prefs[ds]) editingDoc.prefs[ds] = {}; if(val === 0) delete editingDoc.prefs[ds][s]; else editingDoc.prefs[ds][s] = val; openPrefModal(ds); renderPrefCalendar(); }

        let selDate = ""; let selShift = 1;

        function openDayModal(ds) { selDate = ds; selShift = 1; const dObj = new Date(ds); document.getElementById('modalDateTitle').textContent = dObj.toLocaleDateString('tr-TR', { day:'numeric', month:'long', weekday:'long'}); document.getElementById('holidayToggle').checked = isDayHoliday(ds); document.getElementById('holidayToggle').onchange = () => toggleHoliday(ds); const tabs = document.getElementById('modalShiftTabs'); if(settings.mode > 1) { tabs.classList.remove('hidden'); tabs.innerHTML = ''; shiftLabels[settings.mode].forEach((lbl, i) => { const s = i+1; const btn = document.createElement('button'); btn.className = `flex-1 py-2 text-xs font-bold border-b-2 transition ${s===1 ? 'text-blue-600 border-blue-600 bg-blue-50' : 'text-slate-500 border-transparent'}`; btn.textContent = lbl; btn.onclick = () => { selShift = s; Array.from(tabs.children).forEach(b=>b.className='flex-1 py-2 text-xs font-bold border-b-2 border-transparent text-slate-500'); btn.className='flex-1 py-2 text-xs font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50'; renderModalSlots(); }; tabs.appendChild(btn); }); } else { tabs.classList.add('hidden'); } document.getElementById('dayModal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); renderModalSlots(); }

        function closeModal(id) { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('modal-active'); if(id === 'dayModal') renderCalendar(); }

        function renderModalSlots() { const container = document.getElementById('modalSlotsArea'); container.innerHTML = ''; if(!assignments[selDate]) assignments[selDate] = {}; if(!assignments[selDate][`shift${selShift}`]) assignments[selDate][`shift${selShift}`] = {}; const d = new Date(selDate); d.setDate(d.getDate() - 1); const prevDateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; let resting = []; if(assignments[prevDateStr]) { Object.values(assignments[prevDateStr]).forEach(sm=>Object.values(sm).forEach(l=>resting.push(...l))); } resting = [...new Set(resting)]; let busy = []; for(let s=1; s<=settings.mode; s++) { if(s !== selShift && assignments[selDate][`shift${s}`]) Object.values(assignments[selDate][`shift${s}`]).forEach(l=>busy.push(...l)); } const rBox = document.getElementById('restWarningBox'); if(resting.length>0) { rBox.classList.remove('hidden'); document.getElementById('restingCount').textContent=resting.length; } else rBox.classList.add('hidden'); let monthCounts={}; let holidayCounts={}; let totalCounts={}; doctors.forEach(d => { const cm=calculateStats(d.name,false); const ct=calculateStats(d.name,true); monthCounts[d.name]=cm.total; holidayCounts[d.name]=cm.weekend; totalCounts[d.name]=ct.total; }); let isHol = isDayHoliday(selDate); let sorted = [...doctors].sort((a,b) => { const pa = (a.prefs[selDate]&&a.prefs[selDate][selShift])||0; const pb = (b.prefs[selDate]&&b.prefs[selDate][selShift])||0; const gw = (p) => p===1?0:(p===0?1:2); if (pa !== pb) return gw(pa) - gw(pb); if (isHol && holidayCounts[a.name] !== holidayCounts[b.name]) return holidayCounts[a.name] - holidayCounts[b.name]; if (monthCounts[a.name] !== monthCounts[b.name]) return monthCounts[a.name] - monthCounts[b.name]; return totalCounts[a.name] - totalCounts[b.name]; }); settings.slots.forEach(slot => { const current = assignments[selDate][`shift${selShift}`][`slot${slot.id}`] || []; const limit = getSlotLimit(slot, selDate); const div = document.createElement('div'); div.className = "bg-white border border-slate-200 rounded-xl p-3 shadow-sm"; let countCls = "text-slate-500"; if(current.length<limit.min) countCls="text-red-600 font-bold"; else if(current.length>limit.max) countCls="text-orange-500 font-bold"; else if(current.length>0) countCls="text-green-600 font-bold"; div.innerHTML = `<div class="flex justify-between mb-2"><span class="font-bold text-sm text-slate-800">${slot.name}</span><span class="text-xs ${countCls} bg-slate-100 px-2 py-0.5 rounded-full">${current.length} / ${limit.min}-${limit.max}</span></div>`; const btnArea = document.createElement('div'); btnArea.className = "flex flex-wrap gap-2"; sorted.forEach(doc => { const isHere = current.includes(doc.name); const isRest = resting.includes(doc.name); const isBusyToday = busy.includes(doc.name); if((isRest || isBusyToday) && !isHere) return; const pref = (doc.prefs[selDate] && doc.prefs[selDate][selShift]) || 0; let cls = "px-3 py-1.5 rounded-lg text-xs border transition flex items-center gap-1 font-medium "; let icon = ""; let sub = ""; if(isHere) { cls += "bg-blue-600 text-white border-blue-600 shadow-md"; icon = `<i class="fa-solid fa-check"></i>`; if(isRest) { cls = "px-3 py-1.5 rounded-lg text-xs border bg-amber-500 text-white border-amber-600"; sub="(Yorgun)"; } if(isBusyToday) sub="(Ã‡ift)"; } else { cls += "bg-slate-50 text-slate-600 border-slate-200 hover:bg-white"; } if(!isHere) { if(pref===1) icon=`<i class="fa-solid fa-star text-yellow-400"></i>`; if(pref===2) icon=`<i class="fa-solid fa-ban text-red-400"></i>`; } const b = document.createElement('button'); b.className = cls; b.innerHTML = `${icon} ${doc.name} <span class='text-[9px] opacity-70 ml-1'>${sub}</span>`; b.onclick = () => { let c = assignments[selDate][`shift${selShift}`][`slot${slot.id}`] || []; if(c.includes(doc.name)) c = c.filter(n=>n!==doc.name); else { settings.slots.forEach(s => { if(assignments[selDate][`shift${selShift}`][`slot${s.id}`]?.includes(doc.name)) assignments[selDate][`shift${selShift}`][`slot${s.id}`] = assignments[selDate][`shift${selShift}`][`slot${s.id}`].filter(n=>n!==doc.name); }); c.push(doc.name); } assignments[selDate][`shift${selShift}`][`slot${slot.id}`] = c; localStorage.setItem('mediAssignments', JSON.stringify(assignments)); renderModalSlots(); }; btnArea.appendChild(b); }); div.appendChild(btnArea); container.appendChild(div); }); }

        function autoDistribute() { let gapStr = prompt("Vardiyalar/NÃ¶betler arasÄ± minimum dinlenme sÃ¼resi kaÃ§ saat olmalÄ±?", "24"); if (gapStr === null) return; let gapHours = parseInt(gapStr); if (isNaN(gapHours) || gapHours < 0) { alert("GeÃ§ersiz saat!"); return; } const hoursPerShift = 24 / settings.mode; const shiftsToSkip = Math.ceil(gapHours / hoursPerShift); const year=currentDate.getFullYear(); const month=currentDate.getMonth(); const days=new Date(year,month+1,0).getDate(); let monthTotalCounts = {}; let monthHolidayCounts = {}; let cumTotalCounts = {}; doctors.forEach(d => { monthTotalCounts[d.name] = calculateStats(d.name, false).total; monthHolidayCounts[d.name] = calculateStats(d.name, false).weekend; cumTotalCounts[d.name] = calculateStats(d.name, true).total; }); function checkResting(docName, currentD, currentS) { let d = currentD; let s = currentS; for(let i=0; i<shiftsToSkip; i++) { s--; if(s < 1) { s = settings.mode; d--; } if(d < 1) break; const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; if(assignments[dateStr] && assignments[dateStr][`shift${s}`]) { let found = false; Object.values(assignments[dateStr][`shift${s}`]).forEach(list => { if(list.includes(docName)) found = true; }); if(found) return true; } } return false; } for(let d=1; d<=days; d++) { const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const isHol = isDayHoliday(ds); if(!assignments[ds]) assignments[ds]={}; for(let s=1; s<=settings.mode; s++) { let sk = `shift${s}`; if(!assignments[ds][sk]) assignments[ds][sk]={}; settings.slots.forEach(slot => { let asg = assignments[ds][sk][`slot${slot.id}`] || []; const lim = getSlotLimit(slot, ds); if(asg.length < lim.min) { const need = lim.min - asg.length; let cands = doctors.filter(doc => { let busySameShift = false; if(assignments[ds][sk]) { Object.values(assignments[ds][sk]).forEach(l => { if(l.includes(doc.name)) busySameShift=true; }); } if(busySameShift) return false; if(checkResting(doc.name, d, s)) return false; const pref = (doc.prefs[ds] && doc.prefs[ds][s]) || 0; if(pref === 2) return false; return true; }); cands.sort((a,b) => { const pA = (a.prefs[ds]&&a.prefs[ds][s])||0; const pB = (b.prefs[ds]&&b.prefs[ds][s])||0; if(pA===1 && pB!==1) return -1; if(pB===1 && pA!==1) return 1; if(isHol) { if (monthHolidayCounts[a.name] !== monthHolidayCounts[b.name]) return monthHolidayCounts[a.name] - monthHolidayCounts[b.name]; } if (monthTotalCounts[a.name] !== monthTotalCounts[b.name]) return monthTotalCounts[a.name] - monthTotalCounts[b.name]; return cumTotalCounts[a.name] - cumTotalCounts[b.name]; }); for(let i=0; i<need; i++) { if(cands[i]) { const n = cands[i].name; asg.push(n); monthTotalCounts[n]++; cumTotalCounts[n]++; if(isHol) monthHolidayCounts[n]++; } } assignments[ds][sk][`slot${slot.id}`] = asg; } }); } } localStorage.setItem('mediAssignments', JSON.stringify(assignments)); renderCalendar(); alert("DaÄŸÄ±tÄ±m tamamlandÄ±."); }

        function setStatMode(mode) { statMode = mode; document.getElementById('btnStatMonthly').className = `stat-toggle-btn ${mode==='monthly' ? 'stat-toggle-active' : 'stat-toggle-inactive'}`; document.getElementById('btnStatCumulative').className = `stat-toggle-btn ${mode==='cumulative' ? 'stat-toggle-active' : 'stat-toggle-inactive'}`; document.getElementById('statInfoText').textContent = mode === 'monthly' ? `(${new Date(currentDate).toLocaleDateString('tr-TR', { month: 'long' })})` : `(TÃ¼m Zamanlar)`; renderStats(); }

        function renderStats() { if (totalChart) { totalChart.destroy(); totalChart = null; } if (weekendChart) { weekendChart.destroy(); weekendChart = null; } Object.keys(slotCharts).forEach(key => { if(slotCharts[key]) slotCharts[key].destroy(); }); slotCharts = {}; const ctx1 = document.getElementById('totalChart'); const ctx2 = document.getElementById('weekendChart'); const slotContainer = document.getElementById('slotChartsContainer'); if(!ctx1 || !ctx2 || !slotContainer) return; slotContainer.innerHTML = ''; let labels = []; let totalData = []; let weekendData = []; const isCumulative = statMode === 'cumulative'; const sortedDocs = [...doctors].sort((a, b) => a.name.localeCompare(b.name, 'tr')); sortedDocs.forEach(doc => { const s = calculateStats(doc.name, isCumulative); labels.push(doc.name); totalData.push(s.total); weekendData.push(s.weekend); }); totalChart = new Chart(ctx1.getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'Toplam', data: totalData, backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); weekendChart = new Chart(ctx2.getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'Tatil/Haftasonu', data: weekendData, backgroundColor: '#ef4444', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); settings.slots.forEach(slot => { const card = document.createElement('div'); card.className = 'glass-card p-4 rounded-2xl shadow-sm'; card.innerHTML = `<h4 class="text-xs font-bold text-slate-500 uppercase mb-3">${slot.name}</h4><div style="height: 200px;"><canvas id="chart-slot-${slot.id}"></canvas></div>`; slotContainer.appendChild(card); let slotData = []; sortedDocs.forEach(doc => { let count = calculateSlotStats(doc.name, slot.id, isCumulative); slotData.push(count); }); slotCharts[`slot${slot.id}`] = new Chart(document.getElementById(`chart-slot-${slot.id}`).getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: slot.name, data: slotData, backgroundColor: '#8b5cf6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }); }

        function renderSettings() { document.getElementById('slotsConfigList').innerHTML = settings.slots.map((s,i) => `<div class="bg-slate-50 p-2 rounded mb-2 border"><div class="flex justify-between mb-1"><input value="${s.name}" onchange="updateSlot(${i},'name',this.value)" class="bg-white border rounded p-1 text-sm font-bold w-1/2"><button onclick="deleteSlot(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div><div class="flex gap-2 text-xs"><div class="flex-1">Normal: <input type="number" value="${s.min_wd}" onchange="updateSlot(${i},'min_wd',this.value)" class="w-8 border text-center">-<input type="number" value="${s.max_wd}" onchange="updateSlot(${i},'max_wd',this.value)" class="w-8 border text-center"></div><div class="flex-1 text-red-500">Tatil: <input type="number" value="${s.min_we}" onchange="updateSlot(${i},'min_we',this.value)" class="w-8 border text-center">-<input type="number" value="${s.max_we}" onchange="updateSlot(${i},'max_we',this.value)" class="w-8 border text-center"></div></div></div>`).join(''); }

        function updateSlot(i,f,v) { if(f!=='name') v=parseInt(v); settings.slots[i][f]=v; }

        function addNewSlot() { const newId = settings.slots.length > 0 ? Math.max(...settings.slots.map(s => s.id)) + 1 : 1; settings.slots.push({ id: newId, name: "Yeni Saha", min_wd: 1, max_wd: 2, min_we: 1, max_we: 2 }); renderSettings(); }

        function deleteSlot(i) { if(confirm("Silinecek?")) { settings.slots.splice(i, 1); renderSettings(); } }

        function saveSettings() { localStorage.setItem('mediSettings', JSON.stringify(settings)); alert('Ayarlar kaydedildi.'); renderCalendar(); }

        function clearAllSystem() { if(confirm('TÃœM VERÄ°LER SÄ°LÄ°NECEK!')) { localStorage.removeItem('mediAssignments'); localStorage.removeItem('mediDoctors'); localStorage.removeItem('mediHolidays'); location.reload(); } }

        function backupData() { const data = { settings, doctors, assignments, holidays: officialHolidays }; const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `ShiftZen_Yedek_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

        function restoreData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if(data.settings && data.doctors) { if(confirm("Veriler yÃ¼klenecek?")) { localStorage.setItem('mediSettings', JSON.stringify(data.settings)); localStorage.setItem('mediDoctors', JSON.stringify(data.doctors)); localStorage.setItem('mediAssignments', JSON.stringify(data.assignments || {})); localStorage.setItem('mediHolidays', JSON.stringify(data.holidays || [])); location.reload(); } } else { alert("HatalÄ± dosya!"); } } catch(err) { alert("Dosya okunamadÄ±."); } }; reader.readAsText(file); }

        async function downloadFullReport() { const wb = XLSX.utils.book_new(); let summaryMonth = [["Ä°SÄ°M", "TOPLAM", "HAFTAÄ°Ã‡Ä°", "TATÄ°L"]]; const sortedDocs = [...doctors].sort((a, b) => a.name.localeCompare(b.name, 'tr')); sortedDocs.forEach(doc => { const s = calculateStats(doc.name, false); summaryMonth.push([doc.name, s.total, s.total - s.weekend, s.weekend]); }); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryMonth), "Bu AyÄ±n Ã–zeti"); let summaryCum = [["Ä°SÄ°M", "GENEL TOPLAM", "GENEL HAFTAÄ°Ã‡Ä°", "GENEL TATÄ°L"]]; sortedDocs.forEach(doc => { const s = calculateStats(doc.name, true); summaryCum.push([doc.name, s.total, s.total - s.weekend, s.weekend]); }); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryCum), "KÃ¼mÃ¼latif Ã–zet"); let sched = [["TARÄ°H", "GÃœN", "VARDÄ°YA", ...settings.slots.map(s=>s.name)]]; const year=currentDate.getFullYear(); const month=currentDate.getMonth(); const days=new Date(year,month+1,0).getDate(); for(let d=1; d<=days; d++) { const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const dn = new Date(year, month, d).toLocaleDateString('tr-TR', { weekday: 'long' }); const isH = officialHolidays.includes(ds); let dispD = `${d}.${month+1}.${year}` + (isH?" (T)":""); for(let s=1; s<=settings.mode; s++) { let r = [dispD, dn, `${s}. V`]; settings.slots.forEach(slot => { let a = []; if(assignments[ds] && assignments[ds][`shift${s}`]) a = assignments[ds][`shift${s}`][`slot${slot.id}`] || []; r.push(a.join('+')); }); sched.push(r); } } XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sched), "Ã‡izelge"); settings.slots.forEach(slot => { let slotData = [["Ä°SÄ°M", "BU AY", "KÃœMÃœLATÄ°F"]]; doctors.forEach(doc => { slotData.push([doc.name, calculateSlotStats(doc.name, slot.id, false), calculateSlotStats(doc.name, slot.id, true)]); }); let safeName = `DaÄŸÄ±lÄ±m - ${slot.name}`.substring(0, 30); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(slotData), safeName); }); let holidayData = [["Ä°SÄ°M", "BU AY TATÄ°L", "KÃœMÃœLATÄ°F TATÄ°L"]]; doctors.forEach(doc => { holidayData.push([doc.name, calculateStats(doc.name, false).weekend, calculateStats(doc.name, true).weekend]); }); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(holidayData), "Analiz - Genel & Tatil"); XLSX.writeFile(wb, `ShiftZen_Rapor_${new Date(currentDate).toLocaleDateString('tr-TR', {month:'long', year:'numeric'})}.xlsx`); }

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(console.error); }
</script>
</body>
</html>
 
